<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>TITLE CRAFT — by Genial Design</title>
  <meta name="color-scheme" content="dark light" />
  <meta name="theme-color" content="#0b0d12" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <style>
    :root{
      --bg:#0b0d12; --panel:#101522e6; --card:#0e1423cc;
      --muted:#9aa7bd; --text:#e8edf6; --text-weak:#c7d0dd;
      --brand:#86a0ff; --brand-2:#6ee7ff; --ok:#67f3a2; --warn:#ffb85c; --err:#ff6b6b;
      --gold:#ffd76a; --gold2:#ffefb0;
      --glass: blur(16px) saturate(180%); --r-lg:20px; --r-sm:16px; --gap:16px; --tap:56px;
      --shadow: 0 20px 60px rgba(0,0,0,.5), inset 0 1px 0 rgba(255,255,255,.08);
      --focus: 0 0 0 3px color-mix(in srgb, var(--brand) 35%, transparent);
      --safe-bottom: env(safe-area-inset-bottom);
      --safe-top: env(safe-area-inset-top);
    }
    @media (prefers-color-scheme: light){
      :root{ --bg:#f6f7fb; --panel:#ffffffee; --card:#ffffffee; --text:#0a0d14; --text-weak:#1b2230; --muted:#475569; --shadow:0 12px 40px rgba(0,0,0,.12), inset 0 1px 0 rgba(255,255,255,.8); }
    }
    
    *{box-sizing:border-box; -webkit-tap-highlight-color: transparent;}
    html,body{height:100%; overscroll-behavior-y: contain;}
    body{
      margin:0; 
      background: var(--bg);
      color:var(--text); 
      font:500 16px/1.45 -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      overflow-x:hidden;
      -webkit-font-smoothing: antialiased;
      touch-action: pan-y;
    }

    /* ===== ANIMATED BACKGROUND ===== */
    #particles-bg {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
      opacity: 0.4;
    }

    /* ===== ENHANCED PAGE LOADER ===== */
    #pageloader{
      position:fixed; inset:0; 
      background: var(--bg);
      z-index:9999; display:grid; place-items:center;
      transition: opacity .5s cubic-bezier(0.4, 0, 0.2, 1), transform .5s cubic-bezier(0.4, 0, 0.2, 1);
    }
    #pageloader.hidden{ 
      opacity:0; 
      transform: scale(1.1);
      pointer-events: none;
    }
    .pl-card{ text-align:center; animation: float-in 0.8s cubic-bezier(0.34, 1.56, 0.64, 1); }
    .pl-logo{
      width:80px; height:80px; border-radius:24px; object-fit:cover;
      box-shadow:0 20px 60px rgba(134,160,255,.5), 0 0 40px rgba(110,231,255,.3);
      border:2px solid rgba(255,255,255,.2);
      animation: logo-3d 3s ease-in-out infinite, glow-pulse 2s ease-in-out infinite alternate;
      transform-style: preserve-3d;
    }
    @keyframes logo-3d { 
      0%, 100% { transform: perspective(200px) rotateY(0deg) scale(1); }
      50% { transform: perspective(200px) rotateY(15deg) scale(1.05); }
    }
    @keyframes glow-pulse { 
      from{ box-shadow:0 20px 60px rgba(134,160,255,.5), 0 0 40px rgba(110,231,255,.3); }
      to{ box-shadow:0 20px 80px rgba(134,160,255,.7), 0 0 60px rgba(110,231,255,.5); }
    }
    @keyframes float-in {
      from { opacity: 0; transform: translateY(30px) scale(0.9); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }
    .pl-bar{
      margin-top:24px; width:280px; height:8px; border-radius:999px; 
      background:linear-gradient(90deg, #10182b, #1a2444); 
      overflow:hidden; 
      border:1px solid #2a4270;
      box-shadow: inset 0 2px 4px rgba(0,0,0,.3), 0 8px 24px rgba(0,0,0,.3);
    }
    .pl-bar > span{
      display:block; height:100%; width:0%; 
      background:linear-gradient(90deg,#6ee7ff,#86a0ff,#ff6ee7);
      animation: loadline 2.2s cubic-bezier(0.4, 0, 0.2, 1) forwards;
      box-shadow:0 0 20px rgba(110,231,255,.5);
      position: relative;
    }
    .pl-bar > span::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
      animation: shimmer 1s linear infinite;
    }
    @keyframes loadline{ 
      0%{width:0%} 
      50%{width:75%} 
      100%{width:100%} 
    }
    @keyframes shimmer { 
      from { transform: translateX(-100%); }
      to { transform: translateX(100%); }
    }

    /* ===== MAIN APP ===== */
    .app{ 
      max-width:1180px; 
      margin-inline:auto; 
      padding: calc(18px + var(--safe-top)) 14px calc(24px + var(--safe-bottom)); 
      animation: app-slide-up 0.8s cubic-bezier(0.34, 1.56, 0.64, 1) 0.3s both;
    }
    @keyframes app-slide-up {
      from { opacity: 0; transform: translateY(40px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    header{ 
      display:flex; 
      align-items:center; 
      justify-content:space-between; 
      gap:10px; 
      margin-bottom:20px; 
      animation: header-slide 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) 0.5s both;
    }
    @keyframes header-slide {
      from { opacity: 0; transform: translateX(-30px); }
      to { opacity: 1; transform: translateX(0); }
    }
    
    .brand{ display:flex; align-items:center; gap:12px; cursor: pointer; transition: transform 0.3s ease; }
    .brand:active { transform: scale(0.95); }
    .brand .logo{ 
      width:44px; height:44px; border-radius:14px; display:block; object-fit:cover;
      box-shadow:0 12px 32px rgba(134,160,255,.4), 0 0 24px rgba(110,231,255,.2);
      border:2px solid rgba(255,255,255,.15);
      transition: transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    .brand:hover .logo { transform: rotate(10deg) scale(1.1); }
    .brand h1{ margin:0; font-size: clamp(24px, 5vw, 28px); font-weight:900; letter-spacing:1px }
    .brand h1 .main{ 
      display:block; 
      letter-spacing:1.2px;
      background: linear-gradient(120deg, var(--text), var(--brand-2), var(--brand));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .brand h1 .sub{ display:block; font-size:12px; font-weight:800; letter-spacing:.4px; color:var(--muted); margin-top:2px }

    .grid{ display:grid; grid-template-columns: 1fr; gap: 20px; }
    @media (min-width: 960px){ .grid{ grid-template-columns: 380px 1fr; } }

    /* ===== GLASS PANELS ===== */
    .panel{ 
      background: var(--panel); 
      border:1px solid rgba(255,255,255,.1); 
      border-radius: var(--r-lg); 
      box-shadow: var(--shadow); 
      backdrop-filter: var(--glass);
      position: relative;
      overflow: hidden;
    }
    .panel::before {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, transparent 100%);
      pointer-events: none;
    }
    .inputs{ 
      padding:16px;
      animation: panel-slide-left 0.7s cubic-bezier(0.34, 1.56, 0.64, 1) 0.6s both;
    }
    .results{ 
      padding:16px;
      animation: panel-slide-right 0.7s cubic-bezier(0.34, 1.56, 0.64, 1) 0.7s both;
    }
    @keyframes panel-slide-left {
      from { opacity: 0; transform: translateX(-40px); }
      to { opacity: 1; transform: translateX(0); }
    }
    @keyframes panel-slide-right {
      from { opacity: 0; transform: translateX(40px); }
      to { opacity: 1; transform: translateX(0); }
    }

    /* ===== ENHANCED CARDS ===== */
    .cards{ display:flex; flex-direction:column; gap:14px }
    .card{ 
      background: var(--card); 
      border:1px solid rgba(255,255,255,.1); 
      border-radius: var(--r-sm); 
      padding:14px;
      transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
      position: relative;
      transform-style: preserve-3d;
    }
    .card::before {
      content: '';
      position: absolute;
      inset: -2px;
      background: linear-gradient(45deg, var(--brand), var(--brand-2), var(--brand));
      border-radius: inherit;
      opacity: 0;
      transition: opacity 0.3s ease;
      filter: blur(15px);
      z-index: -1;
    }
    .card:hover {
      transform: translateY(-4px) scale(1.02);
      box-shadow: 0 20px 40px rgba(134,160,255,.2), 0 0 30px rgba(110,231,255,.15);
    }
    .card:hover::before { opacity: 0.3; }
    
    .card h3{ 
      margin:0 0 10px; 
      font-size:13px; 
      letter-spacing:.4px; 
      color:var(--text-weak); 
      font-weight:800; 
      text-transform:uppercase;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .card h3 .req { color: var(--brand-2); }
    
    /* ===== ENHANCED FIELDS ===== */
    .field{ 
      display:flex; 
      align-items:center; 
      gap:10px; 
      background:#0f1526; 
      border:2px solid #1f2a44; 
      border-radius:16px; 
      padding:14px; 
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      position: relative;
      overflow: hidden;
    }
    .field::after {
      content: '';
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at var(--mouse-x, 50%) var(--mouse-y, 50%), rgba(134,160,255,0.1), transparent 50%);
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.3s;
    }
    .field:hover::after { opacity: 1; }
    .field:focus-within{ 
      box-shadow: var(--focus), inset 0 0 20px rgba(134,160,255,.05);
      border-color: var(--brand);
      transform: scale(1.02);
    }
    
    .field-clear {
      width: 24px;
      height: 24px;
      padding: 4px;
      cursor: pointer;
      opacity: 0.5;
      transition: all 0.2s ease;
      flex-shrink: 0;
    }
    .field-clear:hover {
      opacity: 1;
      transform: scale(1.1);
    }
    .field-clear svg {
      width: 100%;
      height: 100%;
      fill: var(--muted);
    }
    
    textarea,input{ 
      all:unset; 
      color:var(--text); 
      font:inherit; 
      width:100%; 
      caret-color: var(--brand);
      font-size: 16px; /* Prevent zoom on iOS */
    }
    textarea { min-height: 80px; resize: vertical; }

    /* ===== CONTROLS ===== */
    .controls{ display:grid; grid-template-columns: 1fr; gap:12px; margin-top: 12px; }
    .ctrl{ 
      background:#0f1526; 
      border:2px solid #1f2a44; 
      border-radius:16px; 
      padding:14px; 
      display:flex; 
      align-items:center; 
      justify-content:space-between; 
      gap:10px;
      transition: all 0.3s ease;
    }
    .ctrl:hover { 
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(0,0,0,.2);
    }
    .ctrl label{ font-size:14px; color:var(--text-weak); font-weight: 600; }
    .ctrl input[type="number"]{ 
      all:unset; 
      width:80px; 
      text-align:center; 
      background:#0b1221; 
      border:2px solid #1b2847; 
      border-radius:12px; 
      padding:10px 12px; 
      font-weight:800;
      font-size: 18px;
      transition: all 0.3s ease;
    }
    .ctrl input[type="number"]:focus {
      border-color: var(--brand);
      box-shadow: 0 0 0 3px rgba(134,160,255,.2);
    }
    .ctrl input[type="number"]:invalid{ outline:2px solid var(--err); }

    /* ===== ENHANCED CHECKBOXES ===== */
    .checks{ display:flex; gap:12px; flex-wrap:wrap }
    .check{
      display:flex; 
      align-items:center; 
      gap:12px; 
      padding:14px 16px; 
      border-radius:18px;
      background:#0f1526; 
      border:2px solid #253456; 
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      min-height:52px; 
      user-select:none; 
      position:relative; 
      overflow:hidden;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
    }
    .check:active { transform: scale(0.95); }
    .check input{ 
      width:22px; 
      height:22px; 
      accent-color: var(--brand);
      cursor: pointer;
    }
    .check .tag{ font-weight:800; letter-spacing:.3px; font-size: 15px; }
    .check .state{
      font-size:11px; 
      padding:5px 10px; 
      border-radius:999px; 
      background:linear-gradient(135deg, #1a2240, #253456); 
      border:1px solid #2a3a5f; 
      color:#cfe3ff;
      font-weight: 700;
      letter-spacing: 0.5px;
    }
    .check:has(input:checked){
      background: linear-gradient(135deg, rgba(134,160,255,.15), rgba(110,231,255,.1));
      border-color: var(--brand);
      box-shadow: 0 0 0 3px rgba(134,160,255,.15), 0 8px 20px rgba(134,160,255,.2);
    }
    .check:has(input:not(:checked)){
      border-color: rgba(255,107,107,.3);
      box-shadow: 0 0 0 3px rgba(255,107,107,.1);
    }
    .check:has(input:not(:checked)) .state.data-off::before{ content:attr(data-off) }
    .check:has(input:checked) .state.data-on::before{ content:attr(data-on) }
    
    /* Ripple effect for checkboxes */
    .check::after {
      content: '';
      position: absolute;
      width: 100px;
      height: 100px;
      background: radial-gradient(circle, rgba(255,255,255,0.3), transparent);
      transform: scale(0);
      opacity: 0;
      pointer-events: none;
    }
    .check.ripple::after {
      animation: check-ripple 0.6s ease-out;
    }
    @keyframes check-ripple {
      to { transform: scale(3); opacity: 0; }
    }

    /* ===== SUPER ENHANCED BUTTON ===== */
    .btn{
      --h: 56px; 
      display:inline-flex; 
      align-items:center; 
      justify-content:center; 
      gap:12px;
      height:var(--h); 
      width:100%; 
      border-radius: calc(var(--h)/2);
      border:2px solid rgba(255,255,255,.15); 
      color:#0a0d14; 
      font-weight:900; 
      letter-spacing:.5px;
      font-size: 17px;
      background: linear-gradient(135deg, #86a0ff, #6ee7ff, #ff6ee7);
      box-shadow: 
        0 20px 40px rgba(134,160,255,.4), 
        inset 0 2px 0 rgba(255,255,255,.6), 
        0 0 40px rgba(110,231,255,.2);
      cursor:pointer; 
      user-select:none; 
      position:relative; 
      overflow:hidden;
      transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
      transform-style: preserve-3d;
      -webkit-tap-highlight-color: transparent;
    }
    
    .btn::before, .btn::after {
      content: '';
      position: absolute;
      inset: -30px;
      border-radius: inherit;
      background: radial-gradient(circle at center, rgba(255,255,255,0.3), transparent);
      opacity: 0;
      pointer-events: none;
    }
    .btn::before { animation: pulse-ring 2s cubic-bezier(0.4, 0, 0.2, 1) infinite; }
    .btn::after { animation: pulse-ring 2s cubic-bezier(0.4, 0, 0.2, 1) infinite 1s; }
    
    @keyframes pulse-ring {
      0% { transform: scale(0.8); opacity: 0.5; }
      50% { transform: scale(1.2); opacity: 0; }
      100% { transform: scale(1.5); opacity: 0; }
    }
    
    .btn:hover{ 
      transform: translateY(-3px) scale(1.02);
      box-shadow: 
        0 25px 50px rgba(134,160,255,.5), 
        inset 0 2px 0 rgba(255,255,255,.8), 
        0 0 50px rgba(110,231,255,.3);
    }
    .btn:active{ 
      transform: translateY(0) scale(0.96);
      box-shadow: 
        0 10px 20px rgba(134,160,255,.3), 
        inset 0 1px 3px rgba(0,0,0,.2);
    }
    
    .btn.processing {
      background: linear-gradient(270deg, #86a0ff, #6ee7ff, #ff6ee7, #86a0ff);
      background-size: 400% 400%;
      animation: gradient-shift 3s ease infinite;
    }
    @keyframes gradient-shift {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    
    .btn .spark{ 
      width:20px; 
      height:20px; 
      fill:#0a0d14;
      filter: drop-shadow(0 0 6px rgba(255,255,255,.8));
      animation: spark-rotate 2s linear infinite;
    }
    @keyframes spark-rotate {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    
    .btn .btn-text{ display:inline-flex; align-items:center; gap:6px }
    
    /* Ripple effect on click */
    .btn-ripple {
      position: absolute;
      border-radius: 50%;
      background: rgba(255,255,255,0.5);
      transform: scale(0);
      animation: btn-ripple-effect 0.6s ease-out;
      pointer-events: none;
    }
    @keyframes btn-ripple-effect {
      to { transform: scale(4); opacity: 0; }
    }
    
    .dots{ display:inline-block; width:28px; text-align:left }
    .dots::after{ content:""; display:inline-block; width:1ch; animation: dots 1.2s steps(3,end) infinite }
    @keyframes dots{ 0%{content:""} 33%{content:"."} 66%{content:".."} 100%{content:"..."} }

    /* ===== 3D SESSIONS ===== */
    #stream {
      position: relative;
      min-height: 400px;
      perspective: 1000px;
      transform-style: preserve-3d;
    }
    
    .session{
      padding:0; 
      border:2px solid rgba(255,255,255,.12); 
      border-radius:20px;
      background: linear-gradient(135deg, #0f1420cc, #0b0f1acc);
      margin:0 0 10px 0; 
      box-shadow: 0 20px 40px rgba(0,0,0,.4);
      overflow:hidden;
      transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
      transform-origin: top center;
      transform-style: preserve-3d;
      position: relative;
      cursor: pointer;
    }
    
    /* 3D Stacked effect when collapsed */
    .session.collapsed {
      transform: rotateX(20deg) translateZ(calc(var(--stack-index, 0) * -50px)) translateY(calc(var(--stack-index, 0) * 30px));
      opacity: calc(1 - var(--stack-index, 0) * 0.15);
      margin-bottom: -60px;
    }
    
    .session.collapsed:hover {
      transform: rotateX(20deg) translateZ(calc(var(--stack-index, 0) * -50px + 10px)) translateY(calc(var(--stack-index, 0) * 30px - 5px)) scale(1.02);
    }
    
    /* Expanded state */
    .session.expanded {
      transform: rotateX(0) translateZ(0) translateY(0) !important;
      opacity: 1 !important;
      margin-bottom: 20px;
      z-index: 100;
    }
    
    /* Other cards when one is expanded */
    .session.pushed-down {
      transform: translateY(100px) scale(0.95);
      opacity: 0.3;
      pointer-events: none;
    }
    
    @keyframes session-appear {
      from { 
        opacity: 0; 
        transform: scale(0.9) translateY(20px) rotateX(40deg);
      }
      to { 
        opacity: 1; 
        transform: scale(1) translateY(0) rotateX(20deg);
      }
    }
    
    .session-head{
      display:flex; 
      align-items:center; 
      justify-content:space-between; 
      gap:10px; 
      padding:10px;
      background:linear-gradient(180deg,#0e1423,#0b1020);
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    
    .session-title {
      flex: 1;
      font-size: 14px;
      font-weight: 700;
      color: var(--text-weak);
      padding: 0 10px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .session-actions {
      display: flex;
      gap: 10px;
    }
    
    .iconbtn{
      width:40px; 
      height:40px; 
      border-radius:12px; 
      display:grid; 
      place-items:center;
      background:linear-gradient(135deg, #0d1526, #1a2240); 
      border:2px solid #223456; 
      color:#cfe3ff; 
      cursor:pointer;
      transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .iconbtn:hover{ 
      transform: translateY(-2px) scale(1.1);
      box-shadow: 0 8px 20px rgba(134,160,255,.3);
    }
    .iconbtn:active{ 
      transform: translateY(0) scale(0.95);
    }
    .iconbtn svg{ width:18px; height:18px; fill:#cfe3ff }

    .audience{
      color:var(--text); 
      background:linear-gradient(135deg,#0f1528,#0c1222);
      border-radius:16px; 
      padding:14px; 
      margin:14px; 
      font-size:15px; 
      position:relative;
      border:2px solid #2a3a5f; 
      box-shadow: 0 0 0 3px rgba(134,160,255,.1);
      line-height: 1.6;
    }
    .audience::before{
      content:attr(data-label); 
      position:absolute; 
      top:-12px; 
      left:14px; 
      font-size:12px; 
      padding:4px 10px; 
      border-radius:999px;
      background:linear-gradient(90deg,#86a0ff33,#6ee7ff33); 
      color:#eaf2ff; 
      border:1px solid #3a4f87; 
      font-weight:900; 
      letter-spacing:.5px;
      box-shadow: 0 4px 10px rgba(0,0,0,.2);
    }

    .list{ 
      display:flex; 
      flex-direction:column; 
      gap:14px; 
      padding:0 14px 14px 14px;
    }
    
    /* Collapse animation */
    .session.collapsed .audience, 
    .session.collapsed .list{
      max-height:0; 
      opacity:0; 
      overflow:hidden; 
      padding-top:0; 
      padding-bottom:0; 
      margin:0 14px; 
      border-width:0;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .session:not(.collapsed) .audience, 
    .session:not(.collapsed) .list{
      transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    /* ===== ENHANCED ROWS ===== */
    .row{
      position:relative; 
      display:block;
      background:linear-gradient(135deg, #0b1221, #0f1526); 
      border:2px solid #1b2847; 
      border-radius:18px; 
      padding:16px 14px 14px 14px;
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      box-shadow: 0 8px 20px rgba(0,0,0,.3);
      animation: row-slide-in 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) both;
      animation-delay: calc(var(--row-index, 0) * 0.05s);
      transform-origin: center;
    }
    @keyframes row-slide-in {
      from { 
        opacity: 0; 
        transform: translateX(-20px) scale(0.95);
      }
      to { 
        opacity: 1; 
        transform: translateX(0) scale(1);
      }
    }
    .row:hover {
      transform: translateY(-3px) scale(1.02);
      box-shadow: 0 12px 30px rgba(0,0,0,.4);
    }
    
    .row.top{
      border-color: transparent;
      background-image:
        linear-gradient(#0b1221,#0b1221),
        radial-gradient(200px 80px at 20px 20px, #ffe38d70, transparent 60%),
        linear-gradient(120deg, #ffec9a, #ffd86a, #ffb347);
      background-origin: padding-box, border-box, border-box; 
      background-clip: padding-box, padding-box, border-box;
      box-shadow: 
        0 0 0 4px rgba(255,231,150,.2), 
        0 15px 35px rgba(255,231,150,.15),
        inset 0 1px 0 rgba(255,255,255,.2);
      animation: top-glow 2s ease-in-out infinite alternate;
    }
    @keyframes top-glow {
      from { box-shadow: 0 0 0 4px rgba(255,231,150,.2), 0 15px 35px rgba(255,231,150,.15); }
      to { box-shadow: 0 0 0 6px rgba(255,231,150,.3), 0 20px 45px rgba(255,231,150,.25); }
    }
    
    .badge{
      position:absolute; 
      top:10px; 
      left:10px;
      min-width:32px; 
      height:32px; 
      border-radius:10px; 
      display:grid; 
      place-items:center;
      font-weight:900; 
      color:#cfe3ff; 
      background:linear-gradient(135deg,#233153,#121b2f); 
      border:2px solid #2a3a5f;
      box-shadow:0 6px 15px rgba(0,0,0,.3);
      font-size: 14px;
    }
    .star{ 
      position:absolute; 
      top:10px; 
      left:48px; 
      font-size:16px; 
      color:#ffd76a;
      animation: star-pulse 1.5s ease-in-out infinite;
      filter: drop-shadow(0 0 8px rgba(255,215,106,.6));
    }
    @keyframes star-pulse {
      0%, 100% { transform: scale(1) rotate(0deg); }
      50% { transform: scale(1.2) rotate(10deg); }
    }

    .pair{ display:flex; flex-direction:column; gap:12px; margin-top:18px }
    .line{ 
      display:grid; 
      grid-template-columns: 1fr; 
      gap:8px; 
      padding:10px 12px; 
      border-radius:14px; 
      background:linear-gradient(135deg, #0e172a, #111b30); 
      border:1px dashed #203156;
      transition: all 0.3s ease;
    }
    .line:hover {
      border-style: solid;
      background:linear-gradient(135deg, #111b30, #141e35);
    }
    .label{ 
      font-size:12px; 
      color:#a9b7d0; 
      letter-spacing:.3px; 
      font-weight:800;
      text-transform: uppercase;
    }
    .txt{
      color:var(--text); 
      word-break:break-word; 
      font-size:15px; 
      line-height:1.5;
      cursor:pointer; 
      border-radius:12px; 
      padding:10px 12px; 
      position:relative; 
      outline:none;
      background: linear-gradient(90deg, rgba(255,255,255,.03), rgba(255,255,255,.08), rgba(255,255,255,.03));
      background-size: 200% 100%;
      animation: subtle-shimmer 3s linear infinite;
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      -webkit-tap-highlight-color: transparent;
      min-height: var(--tap);
      display: flex;
      align-items: center;
    }
    @keyframes subtle-shimmer { 
      to { background-position: -200% 0; }
    }
    .txt:hover {
      transform: translateX(4px);
      box-shadow: 0 0 0 2px rgba(110,231,255,.3);
      background: linear-gradient(90deg, rgba(134,160,255,.1), rgba(110,231,255,.1));
    }
    .txt:active{ 
      transform: scale(0.98);
    }
    
    /* Copy animation */
    .txt.copied {
      animation: copy-success 0.5s ease;
    }
    @keyframes copy-success {
      0% { background: linear-gradient(90deg, rgba(103,243,162,.3), rgba(103,243,162,.2)); }
      100% { background: linear-gradient(90deg, rgba(255,255,255,.03), rgba(255,255,255,.08)); }
    }

    .tools{ 
      display:flex; 
      gap:10px; 
      flex-wrap:wrap; 
      justify-content:flex-end; 
      margin:8px 0 12px;
    }
    .chip{ 
      height:40px; 
      padding:0 16px; 
      border-radius:20px; 
      background:linear-gradient(135deg, #0e1627, #1a2240); 
      border:2px solid #2a3a5f; 
      color:#d6e4ff; 
      font-weight:800;
      font-size: 14px;
      cursor:pointer;
      transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
      display: flex;
      align-items: center;
      gap: 6px;
      -webkit-tap-highlight-color: transparent;
    }
    .chip:hover {
      transform: translateY(-2px) scale(1.05);
      box-shadow: 0 8px 20px rgba(134,160,255,.3);
    }
    .chip:active{ 
      transform: translateY(0) scale(0.95);
    }
    .chip.danger{ 
      border-color:#5f2a2a; 
      background:linear-gradient(135deg, #1a0f12, #2a1418); 
      color:#ffc7c7;
    }

    /* ===== ENHANCED TOAST ===== */
    .toast{ 
      position:fixed; 
      left:50%; 
      bottom:calc(20px + var(--safe-bottom)); 
      transform:translateX(-50%) translateY(100px); 
      background:linear-gradient(135deg,#20df92,#6ee7ff); 
      color:#03141a; 
      font-weight:900; 
      font-size:14px; 
      padding:14px 24px; 
      border-radius:999px; 
      box-shadow: 
        0 20px 40px rgba(110,231,255,.3),
        0 0 60px rgba(32,223,146,.2); 
      opacity:0; 
      pointer-events:none; 
      z-index:9999;
      transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    .toast.show{ 
      opacity:1; 
      transform:translateX(-50%) translateY(0);
    }

    /* ===== FLOATING ACTION BUTTON ===== */
    .fab {
      position: fixed;
      bottom: calc(24px + var(--safe-bottom));
      right: 20px;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: linear-gradient(135deg, #86a0ff, #6ee7ff);
      box-shadow: 
        0 10px 30px rgba(134,160,255,.4),
        0 0 40px rgba(110,231,255,.2);
      display: grid;
      place-items: center;
      cursor: pointer;
      z-index: 100;
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      animation: fab-appear 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) 1s both;
      -webkit-tap-highlight-color: transparent;
    }
    @keyframes fab-appear {
      from { 
        opacity: 0; 
        transform: scale(0) rotate(-180deg);
      }
      to { 
        opacity: 1; 
        transform: scale(1) rotate(0);
      }
    }
    .fab:hover {
      transform: scale(1.1) rotate(90deg);
      box-shadow: 
        0 15px 40px rgba(134,160,255,.5),
        0 0 50px rgba(110,231,255,.3);
    }
    .fab:active {
      transform: scale(0.95);
    }
    .fab svg {
      width: 28px;
      height: 28px;
      fill: #0a0d14;
    }
    
    /* Pulse animation for FAB */
    .fab::before {
      content: '';
      position: absolute;
      inset: -10px;
      border-radius: 50%;
      background: radial-gradient(circle, rgba(134,160,255,.4), transparent);
      animation: fab-pulse 2s ease-in-out infinite;
    }
    @keyframes fab-pulse {
      0%, 100% { transform: scale(1); opacity: 0.5; }
      50% { transform: scale(1.3); opacity: 0; }
    }

    /* ===== SKELETON LOADING ===== */
    .skeleton{ 
      border:2px dashed #263a6b; 
      background:linear-gradient(135deg, #0b1020, #0f1424); 
      border-radius:16px; 
      padding:16px; 
      position:relative;
    }
    .pulse{ 
      height:14px; 
      margin:10px 0; 
      border-radius:8px; 
      background: linear-gradient(90deg, rgba(255,255,255,.05), rgba(255,255,255,.15), rgba(255,255,255,.05)); 
      background-size:200% 100%; 
      animation: wave-loading 1.5s linear infinite;
    }
    @keyframes wave-loading { 
      to { background-position: -200% 0; }
    }
    .sk-close{ position:absolute; right:10px; top:10px }
    
    /* ===== UTILITIES ===== */
    .sr-only{ 
      position:absolute; 
      width:1px; 
      height:1px; 
      overflow:hidden; 
      clip:rect(0 0 0 0); 
      white-space:nowrap; 
      clip-path: inset(50%);
    }
    :focus-visible{ 
      outline: 3px solid color-mix(in srgb, var(--brand) 50%, transparent); 
      outline-offset:3px;
    }
    
    /* ===== SWIPE INDICATOR ===== */
    .swipe-hint {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      opacity: 0.3;
      animation: swipe-hint 2s ease-in-out infinite;
    }
    @keyframes swipe-hint {
      0%, 100% { transform: translateY(-50%) translateX(0); }
      50% { transform: translateY(-50%) translateX(-10px); }
    }
    
    /* ===== REDUCE MOTION ===== */
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }
    
    /* ===== PULL TO REFRESH ===== */
    .pull-to-refresh {
      position: fixed;
      top: -60px;
      left: 50%;
      transform: translateX(-50%);
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, #86a0ff, #6ee7ff);
      display: grid;
      place-items: center;
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      z-index: 9999;
    }
    .pull-to-refresh.visible {
      top: 20px;
    }
    .pull-to-refresh.refreshing {
      animation: ptr-spin 1s linear infinite;
    }
    @keyframes ptr-spin {
      from { transform: translateX(-50%) rotate(0deg); }
      to { transform: translateX(-50%) rotate(360deg); }
    }
  </style>
</head>
<body>
  <!-- Particles Background -->
  <canvas id="particles-bg"></canvas>
  
  <!-- Pull to Refresh Indicator -->
  <div class="pull-to-refresh" id="pullToRefresh">
    <svg viewBox="0 0 24 24" width="24" height="24" fill="#0a0d14">
      <path d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6 0 1.01-.25 1.97-.7 2.8l1.46 1.46C19.54 15.03 20 13.57 20 12c0-4.42-3.58-8-8-8zm0 14c-3.31 0-6-2.69-6-6 0-1.01.25-1.97.7-2.8L5.24 7.74C4.46 8.97 4 10.43 4 12c0 4.42 3.58 8 8 8v3l4-4-4-4v3z"/>
    </svg>
  </div>
  
  <!-- Loader -->
  <div id="pageloader" role="status" aria-live="polite" aria-label="Loading">
    <div class="pl-card">
      <img class="pl-logo" src="https://i.imgur.com/NAlA829.jpeg" alt="TITLE CRAFT logo" width="80" height="80" />
      <div class="pl-bar"><span></span></div>
    </div>
  </div>

  <div class="app" aria-hidden="true" id="appRoot">
    <header>
      <div class="brand" id="brand">
        <img class="logo" src="https://i.imgur.com/Q7CqyWC.jpeg" alt="TITLE CRAFT logo" width="44" height="44" decoding="async" loading="lazy" />
        <h1>
          <span class="main">TITLE CRAFT</span>
          <span class="sub">by Genial Design</span>
        </h1>
      </div>
    </header>

    <div class="grid">
      <section class="panel inputs" aria-labelledby="inputs-title">
        <h2 id="inputs-title" class="sr-only">Inputs</h2>
        <div class="cards">
          <div class="card">
            <h3 data-i18n="videoTopic">Video topic <span class="req" aria-hidden="true">*</span></h3>
            <div class="field" id="topicField">
              <textarea id="topic" rows="3" data-i18n-placeholder="topicPlaceholder" placeholder="What's the video about?" aria-required="true"></textarea>
              <div class="field-clear" id="clearTopic" title="Clear field">
                <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
              </div>
            </div>
          </div>
          <div class="card">
            <h3 data-i18n="format">Format (optional)</h3>
            <div class="field" id="formatField">
              <textarea id="format" rows="3" data-i18n-placeholder="formatPlaceholder" placeholder="Documentary, Review, Investigation..."></textarea>
              <div class="field-clear" id="clearFormat" title="Clear field">
                <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
              </div>
            </div>
          </div>
          <div class="card">
            <h3 data-i18n="targetAudience">Target audience (optional)</h3>
            <div class="field" id="audienceField">
              <textarea id="audience" rows="3" data-i18n-placeholder="audiencePlaceholder" placeholder="Niche, age range, region..."></textarea>
              <div class="field-clear" id="clearAudience" title="Clear field">
                <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
              </div>
            </div>
          </div>

          <div class="card">
            <h3 data-i18n="componentsCount">Components & Count</h3>
            <div class="checks" role="group" aria-label="Components">
              <label class="check" id="checkTitles">
                <input type="checkbox" id="wantTitles" checked aria-describedby="titles-state" />
                <span class="tag" data-i18n="titles">Titles</span>
                <span id="titles-state" class="state data-on data-off" aria-hidden="true"></span>
              </label>
              <label class="check" id="checkThumbs">
                <input type="checkbox" id="wantThumbs" checked aria-describedby="thumbs-state" />
                <span class="tag" data-i18n="thumbnailTexts">Thumbnail texts</span>
                <span id="thumbs-state" class="state data-on data-off" aria-hidden="true"></span>
              </label>
            </div>
            <div class="controls">
              <div class="ctrl">
                <label for="count" data-i18n="countLabel">Count (5–15)</label>
                <input 
                  type="number" 
                  id="count" 
                  min="5" 
                  max="15" 
                  value="10" 
                  inputmode="numeric"
                  onblur="this.value = Math.min(15, Math.max(5, this.value || 5));"
                />
              </div>
            </div>
          </div>

          <button id="send" class="btn" aria-busy="false">
            <svg class="spark" viewBox="0 0 24 24" width="20" height="20" aria-hidden="true">
              <path d="M12 2l1.8 4.6L18 8l-4.2 1.4L12 14l-1.8-4.6L6 8l4.2-1.4L12 2z"/>
            </svg>
            <span class="btn-text" data-i18n="send">Send</span>
          </button>
        </div>
      </section>

      <section class="panel results" aria-labelledby="results-title">
        <h2 id="results-title" class="sr-only">Results</h2>
        <div class="tools">
          <button class="chip danger" id="clear-history" data-i18n="clearHistory">🗑 Clear history</button>
        </div>
        <div id="stream"></div>
      </section>
    </div>
  </div>

  <!-- Floating Action Button -->
  <button class="fab" id="fabBtn" aria-label="Quick actions">
    <svg viewBox="0 0 24 24">
  <path d="M4 16a2 2 0 0 1 0-2.83l6.59-6.59a2 2 0 0 1 2.82 0L20 13.17a2 2 0 0 1-2.82 2.83L12 10.83l-5.18 5.17A2 2 0 0 1 4 16z"></path>
</svg>

  </button>

  <div id="toast" class="toast" aria-hidden="true">Copied</div>

<script>
/* ================= HAPTIC ENGINE ================= */
class HapticEngine {
  constructor() {
    this.canVibrate = 'vibrate' in navigator;
    this.enabled = true;
  }
  
  light() {
    if(this.canVibrate && this.enabled) {
      try { navigator.vibrate(10); } catch(e) {}
    }
  }
  
  medium() {
    if(this.canVibrate && this.enabled) {
      try { navigator.vibrate(20); } catch(e) {}
    }
  }
  
  success() {
    if(this.canVibrate && this.enabled) {
      try { navigator.vibrate([30, 50, 30]); } catch(e) {}
    }
  }
  
  error() {
    if(this.canVibrate && this.enabled) {
      try { navigator.vibrate([100, 30, 100, 30, 100]); } catch(e) {}
    }
  }
  
  notification() {
    if(this.canVibrate && this.enabled) {
      try { navigator.vibrate([20, 100, 20]); } catch(e) {}
    }
  }
}

const haptic = new HapticEngine();

/* ================= PARTICLES BACKGROUND ================= */
class ParticlesBackground {
  constructor() {
    this.canvas = document.getElementById('particles-bg');
    this.ctx = this.canvas.getContext('2d');
    this.particles = [];
    this.particleCount = 50;
    this.init();
    this.animate();
    window.addEventListener('resize', () => this.init());
  }
  
  init() {
    this.canvas.width = window.innerWidth;
    this.canvas.height = window.innerHeight;
    this.particles = [];
    
    for(let i = 0; i < this.particleCount; i++) {
      this.particles.push({
        x: Math.random() * this.canvas.width,
        y: Math.random() * this.canvas.height,
        vx: (Math.random() - 0.5) * 0.5,
        vy: (Math.random() - 0.5) * 0.5,
        radius: Math.random() * 2 + 0.5,
        opacity: Math.random() * 0.5 + 0.2
      });
    }
  }
  
  animate() {
    this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
    
    // Draw particles
    this.particles.forEach((p, i) => {
      p.x += p.vx;
      p.y += p.vy;
      
      if(p.x < 0 || p.x > this.canvas.width) p.vx *= -1;
      if(p.y < 0 || p.y > this.canvas.height) p.vy *= -1;
      
      this.ctx.beginPath();
      this.ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
      this.ctx.fillStyle = `rgba(134, 160, 255, ${p.opacity})`;
      this.ctx.fill();
      
      // Draw connections
      this.particles.slice(i + 1).forEach(p2 => {
        const dx = p.x - p2.x;
        const dy = p.y - p2.y;
        const distance = Math.sqrt(dx * dx + dy * dy);
        
        if(distance < 100) {
          this.ctx.beginPath();
          this.ctx.moveTo(p.x, p.y);
          this.ctx.lineTo(p2.x, p2.y);
          this.ctx.strokeStyle = `rgba(110, 231, 255, ${0.2 * (1 - distance / 100)})`;
          this.ctx.stroke();
        }
      });
    });
    
    requestAnimationFrame(() => this.animate());
  }
}

/* ================= PULL TO REFRESH ================= */
class PullToRefresh {
  constructor() {
    this.startY = 0;
    this.pullDistance = 0;
    this.threshold = 100;
    this.indicator = document.getElementById('pullToRefresh');
    this.init();
  }
  
  init() {
    let isRefreshing = false;
    
    document.addEventListener('touchstart', (e) => {
      if(window.scrollY === 0 && !isRefreshing) {
        this.startY = e.touches[0].clientY;
      }
    });
    
    document.addEventListener('touchmove', (e) => {
      if(this.startY && !isRefreshing) {
        this.pullDistance = e.touches[0].clientY - this.startY;
        
        if(this.pullDistance > 0 && this.pullDistance < 200) {
          const progress = Math.min(this.pullDistance / this.threshold, 1);
          document.body.style.transform = `translateY(${this.pullDistance * 0.5}px)`;
          
          if(this.pullDistance > 30) {
            this.indicator.classList.add('visible');
            this.indicator.style.transform = `translateX(-50%) scale(${progress})`;
          }
          
          if(this.pullDistance > this.threshold * 0.5 && this.pullDistance < this.threshold * 0.6) {
            haptic.light();
          }
          if(this.pullDistance > this.threshold && this.pullDistance < this.threshold * 1.1) {
            haptic.medium();
          }
        }
      }
    });
    
    document.addEventListener('touchend', () => {
      if(this.pullDistance > this.threshold && !isRefreshing) {
        isRefreshing = true;
        haptic.success();
        this.indicator.classList.add('refreshing');
        
        setTimeout(() => {
          location.reload();
        }, 1000);
      } else {
        document.body.style.transform = '';
        this.indicator.classList.remove('visible');
        this.indicator.style.transform = '';
      }
      
      this.pullDistance = 0;
      this.startY = 0;
    });
  }
}

/* ================= ENHANCED INTERACTIONS ================= */
function addRippleEffect(element, e) {
  const rect = element.getBoundingClientRect();
  const ripple = document.createElement('div');
  ripple.className = 'btn-ripple';
  
  const size = Math.max(rect.width, rect.height);
  ripple.style.width = ripple.style.height = size + 'px';
  
  if(e.touches) {
    ripple.style.left = (e.touches[0].clientX - rect.left - size / 2) + 'px';
    ripple.style.top = (e.touches[0].clientY - rect.top - size / 2) + 'px';
  } else {
    ripple.style.left = (e.clientX - rect.left - size / 2) + 'px';
    ripple.style.top = (e.clientY - rect.top - size / 2) + 'px';
  }
  
  element.appendChild(ripple);
  setTimeout(() => ripple.remove(), 600);
}

function trackMouseOnField(field) {
  field.addEventListener('mousemove', (e) => {
    const rect = field.getBoundingClientRect();
    const x = ((e.clientX - rect.left) / rect.width) * 100;
    const y = ((e.clientY - rect.top) / rect.height) * 100;
    field.style.setProperty('--mouse-x', x + '%');
    field.style.setProperty('--mouse-y', y + '%');
  });
}

/* ================= TRANSLATIONS (keeping original) ================= */
const translations = {
  en: {
    videoTopic: 'Video topic <span class="req" aria-hidden="true">*</span>',
    topicPlaceholder: "What's the video about?",
    format: 'Format (optional)',
    formatPlaceholder: 'Documentary, Review, Investigation...',
    targetAudience: 'Target audience (optional)',
    audiencePlaceholder: 'Niche, age range, region...',
    componentsCount: 'Components & Count',
    titles: 'Titles',
    thumbnailTexts: 'Thumbnail texts',
    countLabel: 'Count (5–15)',
    send: 'Send',
    clearHistory: '🗑 Clear history',
    copyAllTitles: '⧉ Copy all titles',
    copyAllThumbs: '⧉ Copy all thumbnails',
    stateOn: 'ON',
    stateOff: 'OFF',
    copied: 'Copied',
    copyFailed: 'Copy failed',
    topicRequired: 'Topic is required',
    pleaseWait: 'Please wait — processing',
    working: 'Working',
    formatting: 'Formatting',
    polishing: 'Polishing',
    almostReady: 'Almost ready',
    historyCleared: 'History cleared',
    confirmClear: 'Clear all saved generations? This cannot be undone.',
    requestFailed: 'Request failed.',
    audienceProfile: 'Audience Profile',
    titleLabel: 'Title',
    thumbnailLabel: 'Thumbnail',
    topPick: 'Top pick',
    clickToCopy: 'Click to copy',
    collapseExpand: 'Collapse/Expand',
    removeResult: 'Remove result',
    dismiss: 'Dismiss',
    languageMarker: 'English'
  },
  es: {
    videoTopic: 'Tema del video <span class="req" aria-hidden="true">*</span>',
    topicPlaceholder: '¿De qué trata el video?',
    format: 'Formato (opcional)',
    formatPlaceholder: 'Documental, Reseña, Investigación...',
    targetAudience: 'Audiencia objetivo (opcional)',
    audiencePlaceholder: 'Nicho, rango de edad, región...',
    componentsCount: 'Componentes y cantidad',
    titles: 'Títulos',
    thumbnailTexts: 'Textos de miniatura',
    countLabel: 'Cantidad (5–15)',
    send: 'Enviar',
    clearHistory: '🗑 Borrar historial',
    copyAllTitles: '⧉ Copiar todos los títulos',
    copyAllThumbs: '⧉ Copiar todas las miniaturas',
    stateOn: 'SÍ',
    stateOff: 'NO',
    copied: 'Copiado',
    copyFailed: 'Error al copiar',
    topicRequired: 'El tema es obligatorio',
    pleaseWait: 'Por favor espera — procesando',
    working: 'Trabajando',
    formatting: 'Formateando',
    polishing: 'Puliendo',
    almostReady: 'Casi listo',
    historyCleared: 'Historial borrado',
    confirmClear: '¿Borrar todas las generaciones guardadas? Esto no se puede deshacer.',
    requestFailed: 'Solicitud fallida.',
    audienceProfile: 'Perfil de audiencia',
    titleLabel: 'Título',
    thumbnailLabel: 'Miniatura',
    topPick: 'Mejor opción',
    clickToCopy: 'Clic para copiar',
    collapseExpand: 'Colapsar/Expandir',
    removeResult: 'Eliminar resultado',
    dismiss: 'Cerrar',
    languageMarker: 'Spanish/Español'
  },
  ru: {
    videoTopic: 'Тема видео <span class="req" aria-hidden="true">*</span>',
    topicPlaceholder: 'О чём видео?',
    format: 'Формат (необязательно)',
    formatPlaceholder: 'Документальный, Обзор, Расследование...',
    targetAudience: 'Целевая аудитория (необязательно)',
    audiencePlaceholder: 'Ниша, возраст, регион...',
    componentsCount: 'Компоненты и количество',
    titles: 'Заголовки',
    thumbnailTexts: 'Тексты превью',
    countLabel: 'Количество (5–15)',
    send: 'Отправить',
    clearHistory: '🗑 Очистить историю',
    copyAllTitles: '⧉ Копировать все заголовки',
    copyAllThumbs: '⧉ Копировать все превью',
    stateOn: 'ВКЛ',
    stateOff: 'ВЫКЛ',
    copied: 'Скопировано',
    copyFailed: 'Ошибка копирования',
    topicRequired: 'Тема обязательна',
    pleaseWait: 'Пожалуйста, подождите — обработка',
    working: 'Работаю',
    formatting: 'Форматирую',
    polishing: 'Дорабатываю',
    almostReady: 'Почти готово',
    historyCleared: 'История очищена',
    confirmClear: 'Очистить все сохранённые генерации? Это действие нельзя отменить.',
    requestFailed: 'Запрос не удался.',
    audienceProfile: 'Профиль аудитории',
    titleLabel: 'Заголовок',
    thumbnailLabel: 'Превью',
    topPick: 'Лучший вариант',
    clickToCopy: 'Нажмите для копирования',
    collapseExpand: 'Свернуть/Развернуть',
    removeResult: 'Удалить результат',
    dismiss: 'Закрыть',
    languageMarker: 'Russian/Русский'
  },
  uk: {
    videoTopic: 'Тема відео <span class="req" aria-hidden="true">*</span>',
    topicPlaceholder: 'Про що відео?',
    format: 'Формат (необов\'язково)',
    formatPlaceholder: 'Документальний, Огляд, Розслідування...',
    targetAudience: 'Цільова аудиторія (необов\'язково)',
    audiencePlaceholder: 'Ніша, вік, регіон...',
    componentsCount: 'Компоненти та кількість',
    titles: 'Заголовки',
    thumbnailTexts: 'Тексти прев\'ю',
    countLabel: 'Кількість (5–15)',
    send: 'Відправити',
    clearHistory: '🗑 Очистити історію',
    copyAllTitles: '⧉ Копіювати всі заголовки',
    copyAllThumbs: '⧉ Копіювати всі прев\'ю',
    stateOn: 'УВІМК',
    stateOff: 'ВИМК',
    copied: 'Скопійовано',
    copyFailed: 'Помилка копіювання',
    topicRequired: 'Тема обов\'язкова',
    pleaseWait: 'Будь ласка, зачекайте — обробка',
    working: 'Працюю',
    formatting: 'Форматую',
    polishing: 'Доопрацьовую',
    almostReady: 'Майже готово',
    historyCleared: 'Історію очищено',
    confirmClear: 'Очистити всі збережені генерації? Цю дію не можна скасувати.',
    requestFailed: 'Запит не вдався.',
    audienceProfile: 'Профіль аудиторії',
    titleLabel: 'Заголовок',
    thumbnailLabel: 'Прев\'ю',
    topPick: 'Найкращий варіант',
    clickToCopy: 'Натисніть для копіювання',
    collapseExpand: 'Згорнути/Розгорнути',
    removeResult: 'Видалити результат',
    dismiss: 'Закрити',
    languageMarker: 'Ukrainian/Українська'
  }
};

function detectLanguage() {
  const browserLang = (navigator.language || navigator.userLanguage || 'en').toLowerCase();
  if (browserLang.startsWith('es')) return 'es';
  if (browserLang.startsWith('ru')) return 'ru';
  if (browserLang.startsWith('uk')) return 'uk';
  return 'en';
}

let currentLang = detectLanguage();
let t = translations[currentLang];

function applyTranslations() {
  document.querySelectorAll('[data-i18n]').forEach(el => {
    const key = el.getAttribute('data-i18n');
    if (t[key]) {
      if (el.tagName === 'BUTTON' && el.querySelector('.btn-text')) {
        el.querySelector('.btn-text').innerHTML = t[key];
      } else {
        el.innerHTML = t[key];
      }
    }
  });
  
  document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
    const key = el.getAttribute('data-i18n-placeholder');
    if (t[key]) {
      el.placeholder = t[key];
    }
  });
  
  document.querySelectorAll('[title]').forEach(el => {
    if (el.title === 'Click to copy') el.title = t.clickToCopy;
    if (el.title === 'Collapse/Expand') el.title = t.collapseExpand;
    if (el.title === 'Remove result') el.title = t.removeResult;
    if (el.title === 'Dismiss') el.title = t.dismiss;
    if (el.title === 'Top pick') el.title = t.topPick;
  });
  
  document.querySelectorAll('.state').forEach(el => {
    el.setAttribute('data-on', t.stateOn);
    el.setAttribute('data-off', t.stateOff);
  });
  
  document.documentElement.lang = currentLang;
}

/* ================= CONFIG ================= */
const API_KEY = "AIzaSyBhzx04RA5ozvs-MpC6Q3_TvQGAtZyDCaM";
const MODEL   = "gemini-2.5-pro";
const RETRIES = 5;
const BASE_DELAY = 800;

/* ================= SYSTEM PROMPT (keeping original) ================= */
const SYSTEM_PROMPT = `ROLE & MISSION
You are an expert in viral YouTube titles & thumbnail texts 🔥 with a finely tuned sense for click psychology (hundreds of A/B tests). Your mission: from the user's topic/context, craft options that skyrocket CTR and hold attention.

IMPORTANT: You must respond in the same language as the user's input. If the user writes in Spanish, respond in Spanish. If in Russian, respond in Russian. If in Ukrainian, respond in Ukrainian. Otherwise default to English.

KNOWLEDGE BASE & EXAMPLES (FOR INTERNAL GUIDANCE ONLY — NEVER OUTPUT THIS SECTION)
• Click Mechanics 🧠
  - Core triggers: Curiosity / Promised benefit / FOMO / Surprise / Status.
  - Specificity & novelty: use exact numbers and crisp nouns (e.g., 208% vs 200%; 1,006,513 vs 1,000,000).
  - Title ↔ Thumbnail pairing: title sets intrigue; thumbnail adds a sharp complementary detail (question→hint or hint→answer) — together they tell a 1-second story.

• Emotional Hooks by Niche 🎯 (pick 1–2 per brief)
  - Education/History: surprise, "unknown", myth vs truth ("Unknown fact…", "Myth or truth: …").
  - Cooking: appetite + shock-experiment ("What happens if you eat fast food for a month?").
  - DIY/Handmade: transformation/achievement under time or budget ("Pallet table built in 1 day!").
  - Entertainment/Vlogs: shock, humor ("Cat's reaction to a cucumber?!").
  - Technology/Reviews: novelty, FOMO ("iPhone 15 vs S25: is it worth switching?").
  - Travel: secret spots, cheap hacks, risk/adventure ("Secret spots in … only locals know").
  - Gaming: challenge/records/easter eggs/meta ("TOP 10 hidden levels in …").

• Thumbnail Text — Best Practices 🖼️
  - 1–5 words, ≤50 chars, NO colons ":". 1–2 words in ALL CAPS allowed.
  - Use numbers, a question mark (?), exclamation (!), or ellipsis (…) when natural.
  - Power words ok ("SECRET", "SHOCK", "FREE", "TOP"), but keep it true.
  - Must NOT repeat or paraphrase the title; avoid >70% word overlap; add a complementary hook.

• Title Techniques & Templates (as inspiration only — DO NOT output these headings)
  - Lists (Top-lists): "7 facts about…", "Top 10 …"
  - How-to: "How to … in …"
  - Why…? / What if…? / Mistakes / VS / Personal Experience / Trend / Urgency
  - Before/After; "The whole truth about …"; "You're losing X by not doing Y (FOMO)"

• Presentation tweaks (when natural) ✨
  - In titles, you may use light emojis/special characters for scan-ability; avoid clutter.
  - Front-load the hook in ~first 40 chars; maximize meaning per word; avoid fluff/clichés.

METHODOLOGY (INTERNAL ONLY — NEVER OUTPUT)
• Selection logic ("Chain of Thought"): silently reason about styles best for the niche/audience.
• Chain of Verification: for each candidate, check —
  1) strong emotion/curiosity?  2) instant clarity at scroll speed?  3) impulse to click?
• Target Quality Parameters:
  - Clickability: 15/10
  - Info-structure & clarity: 10/10
  - Unconventionality & creativity: 10/11

VARIATION COVERAGE (WHEN TOPIC ALLOWS)
Across N options include a healthy mix: How-to, Lists/Numbered, Curiosity Gap, VS/Comparison, Personal, Mistakes, Trend/Urgency. Ensure low semantic overlap.

LANGUAGE
You MUST respond in the same language as the user's input. Detect the language from the topic text and use it for ALL output including the audienceProfile field. If unclear, default to English.

==== HARD CONSTRAINTS & OUTPUT CONTRACT (MUST OBEY) ====
1) STRICT JSON ONLY — NO MARKDOWN, NO LISTS, NO COMMENTARY, NO CHAIN-OF-THOUGHT.
   Return exactly ONE JSON object that matches the runtime responseSchema with fields:
   {
     "audienceProfile": "STRING (3–6 concise, merit-focused sentences)",
     "options": [{"title":"STRING","thumbnailText":"STRING"}],
     "topPicks": [{"index":INTEGER},{"index":INTEGER}]
   }

2) COUNT
   - Return exactly N options (N is provided externally in the user block). Do not exceed or fall short.

3) TITLES
   - ≤100 chars; strongest hook in ~first 40 chars; specific power words; truthful (no fake facts).

4) THUMBNAIL TEXTS
   - 1–5 words, ≤50 chars, NO colons ":".
   - 1–2 words in ALL CAPS permitted.
   - Must NOT repeat or paraphrase the title; avoid >70% word overlap; provide a complementary hint.

5) FIELDS — DO NOT ADD ANY OTHERS
   - Do NOT include "style", "triggers", "synergy", "rationale", or any extra keys not in the schema.
   - If the user asked for Titles-only or Thumbnails-only, still keep both keys in each option; set the unused one to "".

6) TOP PICKS
   - Exactly two unique 1-based indexes into the options array (numbers only, no rationales).

7) RELIABILITY GUARD
   - Start your output with "{" and end with "}". No preface/appendix.
   - If you are about to output any extra text or fields, delete them and emit only valid JSON per schema.

RESOLUTION RULES
- On conflict, the schema and HARD CONSTRAINTS override everything else.
- Tease without deception; protect trust; mobile scan-ability first.

FINAL REMINDER
Output ONLY the JSON object conforming to responseSchema — nothing else.`;

/* ================= USER PROMPT BUILDER ================= */
function buildUserBlock({topic, format, audience, wantTitles, wantThumbs, count}){
  const comp =
    wantTitles && wantThumbs ? "Titles & Thumbnail texts" :
    wantTitles ? "Titles only" :
    wantThumbs ? "Thumbnail texts only" : "Titles & Thumbnail texts";
  const lines = [
    `VIDEO TOPIC: ${escapeForPrompt(topic)}`,
    `FORMAT: ${escapeForPrompt(format || "(not specified)")}`,
    `TARGET AUDIENCE: ${escapeForPrompt(audience || "(not specified)")}`,
    `LANGUAGE: auto-detect from topic (current interface language: ${t.languageMarker})`,
    `REQUESTED COMPONENTS: ${comp}`,
    `NUMBER OF VARIANTS: ${count}`,
    `OUTPUT REQUIREMENTS:
• Return exactly ${count} options with the requested components
• Include Audience Profile (3-6 sentences about the target viewers)
• Include Top Picks (2 best options by index)
• IMPORTANT: Respond in the same language as the topic text
• Follow all title and thumbnail text constraints from system instructions`
  ];
  return lines.join("\n");
}

function responseSchema(){
  return {
    type: "OBJECT",
    properties: {
      audienceProfile: { type: "STRING" },
      options: {
        type: "ARRAY",
        items: {
          type: "OBJECT",
          properties: {
            title: { type: "STRING" },
            thumbnailText: { type: "STRING" }
          },
          required: ["title", "thumbnailText"]
        }
      },
      topPicks: {
        type: "ARRAY",
        items: {
          type: "OBJECT",
          properties: {
            index: { type: "INTEGER" }
          },
          required: ["index"]
        }
      }
    },
    required: ["audienceProfile","options","topPicks"]
  };
}

const GENCFG_HQ = {
  temperature: 0.85,
  topP: 0.92,
  maxOutputTokens: 65535,
  responseMimeType: "application/json",
  responseSchema: responseSchema(),
  thinkingConfig: { includeThoughts: false, thinkingBudget: 32768 }
};

/* ================= STORAGE ================= */
const store = {
  saveInputs(v){ localStorage.setItem("tc_inputs_v7", JSON.stringify(v)); },
  loadInputs(){ try{ return JSON.parse(localStorage.getItem("tc_inputs_v7"))||{} }catch{ return {} } },
  addSession(s){ const all = store.loadSessions(); all.unshift(s); localStorage.setItem("tc_sessions_v7", JSON.stringify(all)); },
  loadSessions(){ try{ return JSON.parse(localStorage.getItem("tc_sessions_v7"))||[] }catch{ return [] } },
  clearSessions(){ localStorage.setItem("tc_sessions_v7", JSON.stringify([])); },
  deleteSession(id){ const all = store.loadSessions().filter(x => x.id !== id); localStorage.setItem("tc_sessions_v7", JSON.stringify(all)); }
};

/* ================= UTILS ================= */
const $ = s => document.querySelector(s);
const clamp = (n,min,max)=> Math.max(min, Math.min(max, n));
const clampStr = (s,n)=> (s||"").trim().slice(0,n);
const MAX_CHARS_TOPIC=800, MAX_CHARS_FORMAT=300, MAX_CHARS_AUDIENCE=300;
const toast = (msg)=>{ 
  const actualMsg = t[msg] || msg || t.copied; 
  const el=$("#toast"); 
  el.textContent=actualMsg; 
  el.classList.add("show"); 
  haptic.notification();
  setTimeout(()=> el.classList.remove("show"), 1600);
};
function escapeForPrompt(s){ return (s||"").replace(/[<>]/g, m => ({'<':'&lt;','>':'&gt;'}[m])) }
function nowStr(){ try{ return new Date().toLocaleString('en-GB', { hour12:false, timeZone:'Europe/London' }); }catch{ return new Date().toLocaleString(); } }
function joinParts(parts){ return (parts||[]).map(p=> p.text).filter(Boolean).join("") }
function truncate(s,n){ return s && s.length>n ? s.slice(0,n-1)+'…' : (s||"") }
function uid(){ return 's_'+Date.now().toString(36)+'_'+Math.random().toString(36).slice(2,7) }
function safeParseJSON(m){ if(!m) return null; try{ return JSON.parse(m) }catch{} const a=m.indexOf("{"), b=m.lastIndexOf("}"); if(a>=0&&b>a){ try{ return JSON.parse(m.slice(a,b+1)) }catch{} } return null }

// Extract first sentence from topic
function getFirstSentence(text) {
  if (!text) return '';
  const match = text.match(/^[^.!?]+[.!?]/);
  return match ? match[0].trim() : text.split(/\s+/).slice(0, 5).join(' ') + '...';
}

/* ================= NORMALIZE OUTPUT ================= */
function normalizeOutput(o, opts){
  const { wantTitles, wantThumbs, count } = opts;
  const options = (o.options||[]).slice(0, count).map(x=> ({
    title: wantTitles ? (x.title||"").trim().slice(0,100) : "",
    thumbnailText: wantThumbs ? (x.thumbnailText||"").replace(/:/g,"").trim().slice(0,50) : ""
  }));
  while(options.length < count) options.push({ title: wantTitles ? "" : "", thumbnailText: wantThumbs ? "" : "" });

  const tp = Array.isArray(o.topPicks) ? o.topPicks
              .filter(v => Number.isInteger(v.index))
              .map(v => ({ index: clamp(parseInt(v.index,10)||1, 1, options.length) }))
              .slice(0, 2) : [];

  return { audienceProfile: (o.audienceProfile||"").trim(), options, topPicks: tp };
}

/* ================= NETWORK ================= */
async function callGemini(payload, tries=RETRIES){
  const url = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL}:generateContent?key=${encodeURIComponent(API_KEY)}`;
  let lastErr;
  for(let i=0;i<tries;i++){
    try{
      const res = await fetch(url, { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(payload) });
      if(!res.ok){ const txt = await res.text().catch(()=> ""); throw new Error(`HTTP ${res.status}: ${txt||res.statusText}`) }
      return await res.json();
    }catch(err){
      lastErr = err;
      const delay = BASE_DELAY * Math.pow(2, i) + Math.random()*300;
      await new Promise(r => setTimeout(r, delay));
    }
  }
  throw lastErr;
}

/* ================= RENDER ================= */
function rowHTML(i, opt, topSet, showTitle, showThumb){
  const n = i+1; const isTop = topSet.has(n);
  const titleVal = opt.title || '';
  const thumbVal = opt.thumbnailText || '';
  const titleHTML = showTitle && titleVal ? `
    <div class="line">
      <div class="label">${t.titleLabel}</div>
      <div class="txt" data-kind="title" role="button" tabindex="0" title="${t.clickToCopy}">${titleVal}</div>
    </div>` : '';
  const thumbHTML = showThumb && thumbVal ? `
    <div class="line">
      <div class="label">${t.thumbnailLabel}</div>
      <div class="txt" data-kind="thumb" role="button" tabindex="0" title="${t.clickToCopy}">${thumbVal}</div>
    </div>` : '';
  
  if (!titleHTML && !thumbHTML) return '';
  
  return `
  <div class="row${isTop? ' top':''}" data-idx="${n}" style="--row-index: ${i}">
    <div class="badge" aria-hidden="true">${n}</div>${isTop? `<span class="star" aria-label="${t.topPick}" title="${t.topPick}">★</span>`:''}
    <div class="pair">${titleHTML}${thumbHTML}</div>
  </div>`;
}

function sessionHTML(session){
  const { output, view, input } = session;
  const showTitle = view.wantTitles, showThumb = view.wantThumbs;
  const topSet = new Set((output.topPicks||[]).map(x=> x.index));
  const list = (output.options||[]).map((o,i)=> rowHTML(i,o,topSet,showTitle,showThumb)).filter(Boolean).join('');
  const cardTitle = getFirstSentence(input.topic);
  
  return `
  <article class="session collapsed" role="region" aria-label="Result session" data-id="${session.id}">
    <div class="session-head">
      <span class="session-title">${cardTitle}</span>
      <div class="session-actions">
        <button class="iconbtn close" title="${t.removeResult}" aria-label="${t.removeResult}">
          <svg viewBox="0 0 24 24"><path d="M18.3 5.71L12 12l6.3 6.29-1.41 1.42L10.59 13.4 4.3 19.71 2.89 18.3 9.18 12 2.89 5.71 4.3 4.29 10.59 10.6l6.3-6.31z"/></svg>
        </button>
      </div>
    </div>
    <div class="audience" data-label="${t.audienceProfile}">${output.audienceProfile||''}</div>
    <div class="list">${list}</div>
  </article>`;
}

function skeletonCard(){
  const wrap = document.createElement('div');
  wrap.className = 'session';
  wrap.innerHTML = `
    <div class="session-head">
      <button class="iconbtn sk-close" title="${t.dismiss}" aria-label="${t.dismiss}">
        <svg viewBox="0 0 24 24"><path d="M18.3 5.71L12 12l6.3 6.29-1.41 1.42L10.59 13.4 4.3 19.71 2.89 18.3 9.18 12 2.89 5.71 4.3 4.29 10.59 10.6l6.3-6.31z"/></svg>
      </button>
    </div>
    <div class="skeleton">
      <div class="pulse"></div><div class="pulse"></div><div class="pulse"></div>
    </div>`;
  return wrap;
}

/* ================= 3D CARD SYSTEM ================= */
let cardClickHandler = null;

function setup3DCards() {
  const stream = $('#stream');
  
  // Remove old handler if exists
  if (cardClickHandler) {
    stream.removeEventListener('click', cardClickHandler);
  }
  
  // Update stack indices for collapsed cards
  function updateStackIndices() {
    const sessions = [...stream.querySelectorAll('.session')];
    let stackIndex = 0;
    
    sessions.forEach(session => {
      if (session.classList.contains('collapsed')) {
        session.style.setProperty('--stack-index', stackIndex);
        stackIndex++;
      } else {
        session.style.setProperty('--stack-index', 0);
      }
    });
  }
  
  // Create new handler
  cardClickHandler = (e) => {
    const session = e.target.closest('.session');
    if (!session || e.target.closest('.iconbtn')) return;
    
    const isExpanded = session.classList.contains('expanded');
    const allSessions = [...stream.querySelectorAll('.session')];
    
    if (isExpanded) {
      // Collapse the card
      session.classList.remove('expanded');
      session.classList.add('collapsed');
      allSessions.forEach(s => s.classList.remove('pushed-down'));
    } else {
      // Expand this card and push others down
      allSessions.forEach(s => {
        s.classList.remove('expanded');
        s.classList.add('collapsed');
        if (s !== session) {
          s.classList.add('pushed-down');
        }
      });
      session.classList.remove('collapsed', 'pushed-down');
      session.classList.add('expanded');
    }
    
    haptic.medium();
    setTimeout(updateStackIndices, 50);
  };
  
  // Add new handler
  stream.addEventListener('click', cardClickHandler);
  
  updateStackIndices();
}

/* ================= COPY / CONTROLS ================= */
function attachCopyHandlers(scope=document){
  function copyText(el){
    const text = el?.textContent?.trim() || '';
    if(!text) return;
    navigator.clipboard.writeText(text).then(()=>{
      el.classList.add('copied');
      setTimeout(()=> el.classList.remove('copied'), 500);
      toast('copied');
      haptic.success();
    }).catch(()=> {
      toast('copyFailed');
      haptic.error();
    });
  }
  scope.querySelectorAll('.txt').forEach(el=>{
    el.onclick = (e) => { 
      e.stopPropagation(); 
      copyText(el); 
    };
    el.addEventListener('touchstart', ()=> haptic.light());
    el.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' '){ e.preventDefault(); copyText(el); }});
  });
}

function attachSessionControls(scope=document){
  scope.querySelectorAll('.session .close').forEach(btn=>{
    btn.onclick = (e) => {
      e.stopPropagation();
      const card = btn.closest('.session'); 
      const id = card?.dataset?.id;
      card.style.transform='scale(.95)'; 
      card.style.opacity='0';
      haptic.medium();
      setTimeout(()=>{ 
        card.remove(); 
        if(id) store.deleteSession(id); 
        setup3DCards();
      }, 300);
    };
  });
  scope.querySelectorAll('.sk-close').forEach(btn=>{
    btn.onclick = (e) => { 
      e.stopPropagation();
      const card = btn.closest('.session');
      card.style.transform='scale(.95)'; 
      card.style.opacity='0';
      haptic.light();
      setTimeout(()=> card?.remove(), 300);
    };
  });
}

/* ================= FLOW ================= */
function clampCountInput(){
  const el = $("#count");
  let val = parseInt(el.value||"10",10);
  if(isNaN(val)) val = 10;
  if(val < 1) val = 1;
  if(val > 15) val = 15;
  el.value = String(val);
}

function blinkFields(){
  ['#topicField','#formatField','#audienceField'].forEach(sel=>{
    const host = document.querySelector(sel);
    if(!host) return;
    host.style.boxShadow='0 0 0 3px rgba(110,231,255,.3), inset 0 0 20px rgba(134,160,255,.1)';
    setTimeout(()=> host.style.boxShadow='', 500);
  });
}

let btnMsgTimer=null;
function setBtnBusy(btn, on){
  if(on){
    btn.setAttribute('aria-busy','true'); 
    btn.classList.add('processing'); 
    btn.disabled=true;
    const msgs = [
      t.working, 
      'Analyzing your topic', 
      'Understanding the audience', 
      'Finding viral patterns', 
      'Crafting click-worthy titles', 
      'Optimizing for engagement',
      'Adding psychological triggers',
      'Testing CTR predictions',
      'Finalizing best options',
      t.almostReady
    ];
    let i=0;
    btn.querySelector('.btn-text').innerHTML = `${msgs[i]}<span class="dots"></span>`;
    clearInterval(btnMsgTimer);
    btnMsgTimer = setInterval(()=>{ 
      i=(i+1)%msgs.length; 
      btn.querySelector('.btn-text').innerHTML = `${msgs[i]}<span class="dots"></span>`; 
    }, 10000); // 10 seconds per status
  }else{
    btn.setAttribute('aria-busy','false'); 
    btn.classList.remove('processing'); 
    btn.disabled=false;
    clearInterval(btnMsgTimer); 
    btnMsgTimer=null;
    btn.querySelector('.btn-text').textContent = t.send;
  }
}

async function generate(){
  const btn = $("#send");
  if(btn.getAttribute('aria-busy')==='true'){ 
    toast('pleaseWait'); 
    haptic.error();
    return; 
  }

  const topic = clampStr($("#topic").value, MAX_CHARS_TOPIC);
  const format = clampStr($("#format").value, MAX_CHARS_FORMAT);
  const audience = clampStr($("#audience").value, MAX_CHARS_AUDIENCE);
  let wantTitles = $("#wantTitles").checked, wantThumbs = $("#wantThumbs").checked;
  clampCountInput();
  let count = clamp(parseInt($("#count").value||"10",10)||10, 1, 15);

  if(!wantTitles && !wantThumbs){ wantTitles = true; }
  if(!topic){ 
    $("#topic").focus(); 
    toast("topicRequired"); 
    haptic.error();
    return; 
  }

  store.saveInputs({topic, format, audience, wantTitles, wantThumbs, count});

  setBtnBusy(btn, true);
  blinkFields();
  haptic.medium();

  const stream = $("#stream"); 
  const skel = skeletonCard(); 
  stream.prepend(skel);

  const payload = {
    systemInstruction: { parts: [{ text: SYSTEM_PROMPT }] },
    contents: [{ role: "user", parts: [{ text: buildUserBlock({topic, format, audience, wantTitles, wantThumbs, count}) }] }],
    generationConfig: GENCFG_HQ
  };

  try{
    const json = await callGemini(payload);
    const first = (json.candidates||[])[0];
    const text = joinParts(first?.content?.parts);
    const parsed = safeParseJSON(text);
    if(!parsed || !Array.isArray(parsed.options)) throw new Error('Invalid model response');

    const normalized = normalizeOutput(parsed, { wantTitles, wantThumbs, count });
    const session = { 
      id: uid(), 
      createdAt: nowStr(), 
      input:{topic,format,audience}, 
      view:{ wantTitles, wantThumbs, count }, 
      output: normalized 
    };
    store.addSession(session);

    const cardWrap = document.createElement('div'); 
    cardWrap.innerHTML = sessionHTML(session);
    const newSession = cardWrap.firstElementChild;
    stream.replaceChild(newSession, skel);
    
    // Re-initialize everything for the new content
    attachCopyHandlers(stream);
    attachSessionControls(stream);
    setup3DCards();
    
    // Auto-expand the new card
    setTimeout(() => {
      const allSessions = [...stream.querySelectorAll('.session')];
      allSessions.forEach(s => {
        s.classList.add('collapsed');
        s.classList.remove('expanded');
        if (s !== newSession) {
          s.classList.add('pushed-down');
        }
      });
      newSession.classList.remove('collapsed', 'pushed-down');
      newSession.classList.add('expanded');
      
      // Update stack indices after expansion
      let stackIndex = 0;
      allSessions.forEach(session => {
        if (session.classList.contains('collapsed')) {
          session.style.setProperty('--stack-index', stackIndex);
          stackIndex++;
        } else {
          session.style.setProperty('--stack-index', 0);
        }
      });
    }, 100);
    
    haptic.success();
  }catch(err){
    const message = err?.message||'Unknown error';
    skel.innerHTML = `<div class="session-head">
        <button class="iconbtn sk-close" title="${t.dismiss}" aria-label="${t.dismiss}">
          <svg viewBox="0 0 24 24"><path d="M18.3 5.71L12 12l6.3 6.29-1.41 1.42L10.59 13.4 4.3 19.71 2.89 18.3 9.18 12 2.89 5.71 4.3 4.29 10.59 10.6l6.3-6.31z"/></svg>
        </button>
      </div>
      <div class="skeleton" role="alert" style="border:2px solid #3e2c2c; background:#1a0f12; color:#ffc7c7">
        <div><strong>${t.requestFailed}</strong> ${truncate(message,260)}</div>
      </div>`;
    attachSessionControls(skel);
    haptic.error();
  }finally{
    setBtnBusy(btn,false);
  }
}

/* ================= INIT ================= */
function renderAll(){
  const container = $("#stream"); 
  container.innerHTML = "";
  store.loadSessions().forEach(s => {
    const wrap = document.createElement("div"); 
    wrap.innerHTML = sessionHTML(s);
    container.appendChild(wrap.firstElementChild);
  });
  attachCopyHandlers(container);
  attachSessionControls(container);
  setup3DCards();
}

function bindUI(){
  // Apply translations first
  applyTranslations();
  
  // Initialize particles background
  setTimeout(() => {
    new ParticlesBackground();
  }, 500);
  
  // Initialize pull to refresh
  new PullToRefresh();
  
  // Hide loader
  setTimeout(()=> {
    const pl = $("#pageloader"); 
    if(pl){ 
      pl.classList.add('hidden');
      haptic.light();
    }
    const app = $("#appRoot"); 
    if(app){ app.removeAttribute('aria-hidden'); }
  }, 2200);

  // Load saved inputs
  const inputs = store.loadInputs();
  if(inputs.topic) $("#topic").value=inputs.topic;
  if(inputs.format) $("#format").value=inputs.format;
  if(inputs.audience) $("#audience").value=inputs.audience;
  if(typeof inputs.wantTitles==="boolean") $("#wantTitles").checked=inputs.wantTitles;
  if(typeof inputs.wantThumbs==="boolean") $("#wantThumbs").checked=inputs.wantThumbs;
  if(inputs.count) $("#count").value = clamp(parseInt(inputs.count,10)||10, 1, 15);

  // Count input handlers
  const countEl = $("#count");
  countEl.addEventListener('input', clampCountInput);
  countEl.addEventListener('blur', clampCountInput);
  countEl.addEventListener('keydown', (e)=> {
    if(e.key==='-' || e.key==='e' || e.key==='E' || e.key==='+') e.preventDefault();
  });

  // Clear field buttons
  $("#clearTopic").addEventListener("click", () => {
    $("#topic").value = '';
    $("#topic").focus();
    haptic.light();
  });
  $("#clearFormat").addEventListener("click", () => {
    $("#format").value = '';
    $("#format").focus();
    haptic.light();
  });
  $("#clearAudience").addEventListener("click", () => {
    $("#audience").value = '';
    $("#audience").focus();
    haptic.light();
  });

  // Main button with ripple effect
  const sendBtn = $("#send");
  sendBtn.addEventListener("click", (e) => {
    addRippleEffect(sendBtn, e);
    generate();
  });
  sendBtn.addEventListener("touchstart", () => haptic.light());
  
  // Enter key submit
  document.addEventListener("keydown", (e)=>{ 
    if(e.key==='Enter' && ['topic','format','audience'].includes(document.activeElement?.id)){ 
      e.preventDefault(); 
      generate(); 
    } 
  });

  // Clear history
  $("#clear-history").addEventListener("click", ()=>{
    if(confirm(t.confirmClear)){
      store.clearSessions(); 
      renderAll(); 
      toast("historyCleared");
      haptic.success();
    }
  });
  $("#clear-history").addEventListener("touchstart", () => haptic.light());

  // Checkbox ripple effects
  ["#checkTitles", "#checkThumbs"].forEach(id => {
    const check = $(id);
    check.addEventListener("click", () => {
      check.classList.add('ripple');
      haptic.light();
      setTimeout(() => check.classList.remove('ripple'), 600);
    });
  });

  // Field mouse tracking
  ["#topicField", "#formatField", "#audienceField"].forEach(id => {
    const field = $(id);
    if(field) trackMouseOnField(field);
  });

  // FAB button
  $("#fabBtn").addEventListener("click", () => {
    window.scrollTo({ top: 0, behavior: 'smooth' });
    haptic.medium();
  });
  $("#fabBtn").addEventListener("touchstart", () => haptic.light());

  // Brand click
  $("#brand").addEventListener("click", () => {
    haptic.light();
  });

  // Render all sessions
  renderAll();
  
  // Reduce animations on low battery
  if ('getBattery' in navigator) {
    navigator.getBattery().then(battery => {
      if(battery.level < 0.2) {
        document.body.style.setProperty('--reduce-animations', '1');
      }
    });
  }
}

// Start app
bindUI();
</script>
</body>
</html>
