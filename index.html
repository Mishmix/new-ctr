<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>TitleCraft — Premium CTR Titles & Thumbnails</title>
  <meta name="color-scheme" content="dark light" />
  <style>
    :root{
      --bg:#0b0d12; --panel:#101522e6; --card:#0e1423cc;
      --muted:#9aa7bd; --text:#e8edf6; --text-weak:#c7d0dd;
      --brand:#86a0ff; --brand-2:#6ee7ff; --ok:#67f3a2; --warn:#ffb85c; --err:#ff6b6b;
      --glass: blur(10px) saturate(120%); --r-lg:16px; --r-sm:12px; --gap:16px; --tap:44px;
      --shadow: 0 10px 30px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.05);
      --focus: 0 0 0 3px color-mix(in srgb, var(--brand) 35%, transparent);
    }
    @media (prefers-color-scheme: light){
      :root{ --bg:#f6f7fb; --panel:#ffffffee; --card:#ffffffee; --text:#0a0d14; --text-weak:#1b2230; --muted:#475569; --shadow:0 8px 24px rgba(0,0,0,.08), inset 0 1px 0 rgba(255,255,255,.6); }
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{
      margin:0; background: radial-gradient(1200px 800px at 85% -10%, #172033 0%, transparent 64%),
                           radial-gradient(1200px 800px at -10% 120%, #111a2b 0%, transparent 55%), var(--bg);
      color:var(--text); font:500 16px/1.45 Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "SF Pro Text", Arial;
      overflow-x:hidden;
    }
    .app{ max-width:1180px; margin-inline:auto; padding:18px 14px 24px; }
    header{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:14px; }
    .brand{ display:flex; align-items:center; gap:10px; }
    .brand .logo{ width:36px; height:36px; border-radius:10px; display:block; object-fit:cover; background:none; box-shadow:0 8px 22px rgba(124,147,255,.35); border:1px solid rgba(255,255,255,.12) }
    h1{ margin:0; font-size: clamp(18px, 4.5vw, 22px); font-weight:800 }
    .status{ color:var(--muted); font-size:12px }

    .grid{ display:grid; grid-template-columns: 1fr; gap: var(--gap); }
    @media (min-width: 960px){ .grid{ grid-template-columns: 360px 1fr; } }

    .panel{ background: var(--panel); border:1px solid rgba(255,255,255,.08); border-radius: var(--r-lg); box-shadow: var(--shadow); backdrop-filter: var(--glass); }
    .inputs{ padding:12px } .results{ padding:12px }

    .cards{ display:flex; flex-direction:column; gap:12px }
    .card{ background: var(--card); border:1px solid rgba(255,255,255,.08); border-radius: var(--r-sm); padding:12px; }
    .card h3{ margin:0 0 8px; font-size:12px; letter-spacing:.3px; color:var(--text-weak); font-weight:800; text-transform:uppercase }
    .field{ display:flex; align-items:center; gap:8px; background:#0f1526; border:1px solid #1f2a44; border-radius:12px; padding:12px; }
    textarea,input{ all:unset; color:var(--text); font:inherit; width:100%; caret-color: var(--brand); }
    .field:focus-within{ box-shadow: var(--focus) }

    /* Controls */
    .controls{ display:grid; grid-template-columns: 1fr; gap:10px; }
    .ctrl{ background:#0f1526; border:1px solid #1f2a44; border-radius:12px; padding:10px; display:flex; align-items:center; justify-content:space-between; gap:8px }
    .ctrl label{ font-size:13px; color:var(--text-weak) }
    .ctrl input[type="number"]{ all:unset; width:64px; text-align:center; background:#0b1221; border:1px solid #1b2847; border-radius:10px; padding:6px 8px }

    /* Explicit, noticeable checkboxes */
    .checks{ display:flex; gap:10px; flex-wrap:wrap }
    .check{
      display:flex; align-items:center; gap:10px; padding:12px 14px; border-radius:14px;
      background:#0f1526; border:2px solid #253456; transition:.2s ease;
      min-height:48px; user-select:none;
    }
    .check input{ width:20px; height:20px; accent-color: var(--brand); }
    .check .tag{ font-weight:800; letter-spacing:.3px }
    .check .state{
      font-size:11px; padding:4px 8px; border-radius:999px; background:#1a2240; border:1px solid #2a3a5f; color:#cfe3ff
    }
    /* Highlight when checked */
    .check:has(input:checked){
      background: linear-gradient(180deg, rgba(134,160,255,.12), rgba(110,231,255,.08));
      border-color: color-mix(in srgb, var(--brand) 60%, #253456);
      box-shadow: 0 0 0 3px color-mix(in srgb, var(--brand) 20%, transparent);
    }
    .check:has(input:checked) .state{ background:linear-gradient(90deg,#86a0ff33,#6ee7ff33); border-color:#3a4f87; color:#eaf2ff }
    .check:has(input:not(:checked)) .state::before{ content:"OFF" }
    .check:has(input:checked) .state::before{ content:"ON" }

    .btn{
      --h: 48px; display:inline-flex; align-items:center; justify-content:center; gap:10px;
      height:var(--h); width:100%; border-radius: calc(var(--h)/2);
      border:1px solid rgba(255,255,255,.09); color:#0a0d14; font-weight:900; letter-spacing:.3px;
      background: linear-gradient(180deg, #c9d0ff, #86a0ff 65%, #6ee7ff 100%);
      box-shadow: 0 10px 30px rgba(124,147,255,.35), inset 0 1px 0 rgba(255,255,255,.7);
      cursor:pointer; user-select:none; transition: transform .15s ease, box-shadow .2s ease, filter .2s ease;
    }
    .btn:hover{ transform: translateY(-1px) } .btn:active{ transform: translateY(0) scale(.98) } .btn[aria-busy="true"]{ filter:saturate(.7); cursor:progress }
    .spinner{ width:16px; height:16px; border-radius:50%; border:2.5px solid rgba(0,0,0,.2); border-top-color:#0a0d14; animation:spin 1s linear infinite }
    @keyframes spin{ to{ transform:rotate(360deg) } }

    /* Results */
    .session{ padding:12px; border:1px solid rgba(255,255,255,.08); border-radius:14px; background:linear-gradient(180deg, #0f1420b8, #0b0f1ab8); margin-bottom:12px; }
    .audience{ color:var(--text); background:#0f1522; border:1px solid #1e2a42; border-radius:12px; padding:12px; margin:6px 0 12px; font-size:14px }
    .tools{ display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; margin:6px 0 10px }
    .chip{ height:36px; padding:0 12px; border-radius:12px; background:#0e1627; border:1px solid #2a3a5f; color:#d6e4ff; font-weight:800; cursor:pointer }
    .chip.danger{ border-color:#5f2a2a; background:#1a0f12; color:#ffc7c7 }
    .chip:active{ transform: translateY(1px) }

    .list{ display:flex; flex-direction:column; gap:10px }
    .row{ position:relative; display:grid; grid-template-columns: auto 1fr auto; gap:10px; align-items:start; background:#0b1221; border:1px solid #1b2847; border-radius:12px; padding:10px; }
    .row.top{ border-color:transparent; background-image:
      linear-gradient(#0b1221,#0b1221),
      radial-gradient(120px 50px at 12px 12px, #98aaff80, transparent 60%),
      linear-gradient(120deg, #8ea2ff, #6ee7ff);
      background-origin: padding-box, border-box, border-box; background-clip: padding-box, padding-box, border-box;
      box-shadow: 0 0 0 4px rgba(124,147,255,.10);
    }
    .num{ display:flex; align-items:center; gap:8px; }
    .badge{ min-width:32px; height:32px; border-radius:10px; display:grid; place-items:center; font-weight:900; color:#cfe3ff; background:linear-gradient(180deg,#233153,#121b2f); border:1px solid #2a3a5f }
    .star{ font-size:14px; color:#ffd76a; margin-left:2px }

    .pair{ display:flex; flex-direction:column; gap:8px }
    .line{ display:grid; grid-template-columns: auto 1fr; align-items:start; gap:8px; padding:6px 8px; border-radius:10px; background:#0e172a; border:1px dashed #203156 }
    .label{ font-size:12px; color:#a9b7d0; letter-spacing:.2px; align-self:center }
    .txt{ color:var(--text); word-break:break-word; font-size:15px }

    .actions{ display:flex; align-items:center; justify-content:flex-end; gap:8px }
    .copy{ min-width:var(--tap); height:var(--tap); display:grid; place-items:center; border-radius:10px; border:1px solid #2a3a5f; background:#0e1627; cursor:pointer }
    .copy svg{ width:18px; height:18px; fill:#cfe3ff }
    .copy:active{ transform: translateY(1px) }

    .toast{ position:fixed; left:50%; bottom:18px; transform:translateX(-50%) translateY(16px); background:linear-gradient(90deg,#20df92,#6ee7ff); color:#03141a; font-weight:900; font-size:12px; padding:10px 14px; border-radius:999px; box-shadow:0 10px 24px rgba(110,231,255,.25); opacity:0; pointer-events:none }
    .toast.show{ opacity:1; transform:translateX(-50%) translateY(0); transition:.25s ease }

    .skeleton{ border:1px dashed #263a6b; background:#0b1020; border-radius:12px; padding:12px }
    .pulse{ height:12px; margin:8px 0; border-radius:6px; background: linear-gradient(90deg, rgba(255,255,255,.05), rgba(255,255,255,.12), rgba(255,255,255,.05)); background-size:200% 100%; animation: shimmer 1.2s linear infinite }
    @keyframes spin{ to{ transform:rotate(360deg) } } @keyframes shimmer{ to{ background-position:-200% 0 } }
    :focus-visible{ outline: 3px solid color-mix(in srgb, var(--brand) 50%, transparent); outline-offset:2px }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="brand">
        <img class="logo" src="https://i.imgur.com/Q7CqyWC.jpeg" alt="TitleCraft logo" width="36" height="36" decoding="async" loading="lazy" />
        <h1>TitleCraft</h1>
      </div>
      <div id="status" class="status" role="status" aria-live="polite">Ready</div>
    </header>

    <div class="grid">
      <section class="panel inputs" aria-labelledby="inputs-title">
        <h2 id="inputs-title" class="sr-only">Inputs</h2>
        <div class="cards">
          <div class="card">
            <h3>Video topic <span class="req" aria-hidden="true">*</span></h3>
            <div class="field"><textarea id="topic" rows="3" placeholder="What’s the video about?" aria-required="true"></textarea></div>
          </div>
          <div class="card">
            <h3>Format (optional)</h3>
            <div class="field"><input id="format" placeholder="Documentary, Review, Investigation..." /></div>
          </div>
          <div class="card">
            <h3>Target audience (optional)</h3>
            <div class="field"><input id="audience" placeholder="Niche, age range, region..." /></div>
          </div>

          <div class="card">
            <h3>Components & Count</h3>
            <div class="checks" role="group" aria-label="Components">
              <label class="check">
                <input type="checkbox" id="wantTitles" checked aria-describedby="titles-state" />
                <span class="tag">Titles</span>
                <span id="titles-state" class="state" aria-hidden="true"></span>
              </label>
              <label class="check">
                <input type="checkbox" id="wantThumbs" checked aria-describedby="thumbs-state" />
                <span class="tag">Thumbnail texts</span>
                <span id="thumbs-state" class="state" aria-hidden="true"></span>
              </label>
            </div>
            <div class="controls" style="margin-top:10px">
              <div class="ctrl">
                <label for="count">Count (1–15)</label>
                <input type="number" id="count" min="1" max="15" value="10" inputmode="numeric" />
              </div>
            </div>
          </div>

          <button id="send" class="btn" aria-busy="false">
            <svg class="spark" viewBox="0 0 24 24" width="18" height="18" aria-hidden="true"><path d="M12 2l1.8 4.6L18 8l-4.2 1.4L12 14l-1.8-4.6L6 8l4.2-1.4L12 2z"/></svg>
            <span>Send</span>
          </button>
        </div>
      </section>

      <section class="panel results" aria-labelledby="results-title">
        <h2 id="results-title" class="sr-only">Results</h2>
        <div class="tools">
          <button class="chip danger" id="clear-history" title="Clear all generations" aria-label="Clear all generations">🗑 Clear history</button>
          <button class="chip" id="copy-all-titles" title="Copy all titles">⧉ Copy all titles</button>
          <button class="chip" id="copy-all-thumbs" title="Copy all thumbnail texts">⧉ Copy all thumbnails</button>
        </div>
        <div id="stream"></div>
      </section>
    </div>
  </div>

  <div id="toast" class="toast" aria-hidden="true">Copied</div>

<script>
/* ================= CONFIG (HQ always on) ================= */
const API_KEY = "AIzaSyDkowFTxiuya3AKjX4yaoA4XaTEK13OXx8";
const MODEL   = "gemini-2.5-pro";
const RETRIES = 5;
const BASE_DELAY = 800; // ms

// HQ config (no toggle)
const GENCFG_HQ = {
  temperature: 0.85,
  topP: 0.92,
  maxOutputTokens: 65535,
  responseMimeType: "application/json",
  responseSchema: responseSchema(),
  thinkingConfig: { includeThoughts: false, thinkingBudget: 32768 }
};

/* ================= STORAGE ================= */
const store = {
  saveInputs(v){ localStorage.setItem("tc_inputs_v3", JSON.stringify(v)); },
  loadInputs(){ try{ return JSON.parse(localStorage.getItem("tc_inputs_v3"))||{} }catch{ return {} } },
  addSession(s){ const all = store.loadSessions(); all.unshift(s); localStorage.setItem("tc_sessions_v3", JSON.stringify(all)); },
  loadSessions(){ try{ return JSON.parse(localStorage.getItem("tc_sessions_v3"))||[] }catch{ return [] } },
  clearSessions(){ localStorage.setItem("tc_sessions_v3", JSON.stringify([])); }
};

/* ================= UTILS ================= */
const $ = s => document.querySelector(s);
const status = m => { const el = $("#status"); if(el) el.textContent = m };
const clamp = (n,min,max)=> Math.max(min, Math.min(max, n));
const clampStr = (s,n)=> (s||"").trim().slice(0,n);
const MAX_CHARS_TOPIC=800, MAX_CHARS_FORMAT=300, MAX_CHARS_AUDIENCE=300;
const toast = (msg="Copied")=>{ const t=$("#toast"); t.textContent=msg; t.classList.add("show"); setTimeout(()=> t.classList.remove("show"), 1100) };
function escapeForPrompt(s){ return (s||"").replace(/[<>]/g, m => ({'<':'&lt;','>':'&gt;'}[m])) }
function safeParseJSON(m){ if(!m) return null; try{ return JSON.parse(m) }catch{} const a=m.indexOf("{"), b=m.lastIndexOf("}"); if(a>=0&&b>a){ try{ return JSON.parse(m.slice(a,b+1)) }catch{} } return null }
function nowStr(){ try{ return new Date().toLocaleString('en-GB', { hour12:false, timeZone:'Europe/London' }); }catch{ return new Date().toLocaleString(); } }
function joinParts(parts){ return (parts||[]).map(p=> p.text).filter(Boolean).join("") }
function truncate(s,n){ return s && s.length>n ? s.slice(0,n-1)+'…' : (s||"") }

/* ================= PROMPT (system/user split) ================= */
const SYSTEM_PROMPT = `You are a YouTube title & thumbnail copywriter focused on CTR. Return concise, high-impact options. Never reveal chain-of-thought. Avoid clickbait lies; promise real, specific value. Follow strict per-item limits: Title <= 100 chars; Thumbnail Text <= 50 chars (1–5 words, NO colons). Produce exactly the components and number of options specified by the user. If Top picks are requested, include only indexes (and rationales only if explicitly requested).`;

function buildUserBlock({topic, format, audience, wantTitles, wantThumbs, count}){
  const comp =
    wantTitles && wantThumbs ? "Titles & Thumbnail texts" :
    wantTitles ? "Titles only" :
    wantThumbs ? "Thumbnail texts only" : "Titles & Thumbnail texts";
  const lines = [
    `VIDEO TOPIC: ${escapeForPrompt(topic)}`,
    `FORMAT: ${escapeForPrompt(format || "(not specified)")}`,
    `TARGET AUDIENCE: ${escapeForPrompt(audience || "(not specified)")}`,
    `LANGUAGE: auto-detect (fallback: English)`,
    `REQUESTED COMPONENTS: ${comp}`,
    `NUMBER OF VARIANTS: ${count} (between 1 and 15)`,
    `OUTPUT SPEC:
• Audience Profile (3–6 sentences; concrete, merit-oriented).
• Options: produce exactly the requested number with only the requested components.
• Style: click-worthy, clear benefits, avoid clickbait lies.`
  ];
  return lines.join("\n");
}

function responseSchema(){
  return {
    type: "OBJECT",
    properties: {
      audienceProfile: { type: "STRING" },
      options: {
        type: "ARRAY",
        items: {
          type: "OBJECT",
          properties: {
            title: { type: "STRING" },
            thumbnailText: { type: "STRING" }
          }
        }
      },
      topPicks: {
        type: "ARRAY",
        items: {
          type: "OBJECT",
          properties: {
            index: { type: "INTEGER" },
            rationale: { type: "STRING" }
          }
        }
      }
    },
    required: ["audienceProfile","options"]
  };
}

/* ================= API with retry/backoff ================= */
async function callGemini(payload, tries=RETRIES){
  const url = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL}:generateContent?key=${encodeURIComponent(API_KEY)}`;
  let lastErr;
  for(let i=0;i<tries;i++){
    try{
      const res = await fetch(url, { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(payload) });
      if(!res.ok){ const txt = await res.text().catch(()=> ""); throw new Error(`HTTP ${res.status}: ${txt||res.statusText}`) }
      return await res.json();
    }catch(err){
      lastErr = err;
      const delay = BASE_DELAY * Math.pow(2, i) + Math.random()*300;
      await new Promise(r => setTimeout(r, delay));
    }
  }
  throw lastErr;
}

/* ================= RENDER ================= */
function skeletonCard(){
  const wrap = document.createElement('div');
  wrap.className = 'session';
  wrap.innerHTML = `<div class="skeleton"><div class="pulse"></div><div class="pulse"></div><div class="pulse"></div></div>`;
  return wrap;
}
function iconCopy(){ return '<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M16 1H4c-1.1 0-2 .9-2 2v12h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>' }

function rowHTML(i, opt, topSet, showTitle, showThumb){
  const n = i+1; const isTop = topSet.has(n);
  const titleHTML = showTitle ? `<div class="line"><div class="label">Title</div><div class="txt" data-kind="title">${opt.title||''}</div></div>` : '';
  const thumbHTML = showThumb ? `<div class="line"><div class="label">Thumbnail</div><div class="txt" data-kind="thumb">${(opt.thumbnailText||'').replace(/:/g,'')}</div></div>` : '';
  const copyBtns = `
    ${showTitle ? `<button class="copy" title="Copy title" aria-label="Copy title" data-copy="title">${iconCopy()}</button>`:''}
    ${showThumb ? `<button class="copy" title="Copy thumbnail" aria-label="Copy thumbnail" data-copy="thumb">${iconCopy()}</button>`:''}
  `;
  return `
  <div class="row${isTop? ' top':''}" data-idx="${n}">
    <div class="num"><div class="badge" aria-hidden="true">${n}</div>${isTop? '<span class="star" aria-label="Top pick" title="Top pick">★</span>':''}</div>
    <div class="pair">${titleHTML}${thumbHTML}</div>
    <div class="actions">${copyBtns}</div>
  </div>`;
}

function sessionHTML(session){
  const { output, view } = session;
  const showTitle = view.wantTitles, showThumb = view.wantThumbs;
  const topSet = new Set((output.topPicks||[]).map(x=> x.index));
  const list = (output.options||[]).map((o,i)=> rowHTML(i,o,topSet,showTitle,showThumb)).join('');
  return `
  <article class="session" role="region" aria-label="Result session">
    <div class="audience">${output.audienceProfile||''}</div>
    <div class="list">${list}</div>
  </article>`;
}

function attachCopyHandlers(scope=document){
  scope.querySelectorAll('.copy').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const row = btn.closest('.row'); const kind=btn.dataset.copy;
      const text = row.querySelector(`.txt[data-kind="${kind==='title'?'title':'thumb'}"]`)?.textContent || '';
      navigator.clipboard.writeText(text).then(()=> toast('Copied')).catch(()=> toast('Copy failed'));
    })
  });
}

/* ================= FLOW ================= */
function getGenConfig(){ return GENCFG_HQ; } // HQ всегда

async function generate(){
  const topic = clampStr($("#topic").value, MAX_CHARS_TOPIC);
  const format = clampStr($("#format").value, MAX_CHARS_FORMAT);
  const audience = clampStr($("#audience").value, MAX_CHARS_AUDIENCE);
  let wantTitles = $("#wantTitles").checked, wantThumbs = $("#wantThumbs").checked;
  let count = clamp(parseInt($("#count").value||"10",10)||10, 1, 15);

  if(!wantTitles && !wantThumbs){ wantTitles = true; } // хотя бы что-то
  if(!topic){ status("Topic is required"); $("#topic").focus(); return; }

  store.saveInputs({topic, format, audience, wantTitles, wantThumbs, count});

  const btn = $("#send"); btn.setAttribute('aria-busy','true'); btn.disabled=true; status('Sending…');
  const stream = $("#stream"); const skel = skeletonCard(); stream.prepend(skel);

  const payload = {
    systemInstruction: { parts: [{ text: SYSTEM_PROMPT }] },
    contents: [{ role: "user", parts: [{ text: buildUserBlock({topic, format, audience, wantTitles, wantThumbs, count}) }] }],
    generationConfig: getGenConfig()
  };

  try{
    const json = await callGemini(payload);
    const first = (json.candidates||[])[0];
    const text = joinParts(first?.content?.parts);
    const parsed = safeParseJSON(text);
    if(!parsed || !Array.isArray(parsed.options)) throw new Error('Invalid model response');

    const normalized = normalizeOutput(parsed, { wantTitles, wantThumbs, count });
    const session = { createdAt: nowStr(), input:{topic,format,audience}, view:{ wantTitles, wantThumbs, count }, output: normalized };
    store.addSession(session);

    const cardWrap = document.createElement('div'); cardWrap.innerHTML = sessionHTML(session);
    stream.replaceChild(cardWrap, skel);
    attachCopyHandlers(cardWrap);
    status('Done');
  }catch(err){
    skel.innerHTML = `<div class="skeleton" role="alert" style="border:1px solid #3e2c2c; background:#1a0f12; color:#ffc7c7">
      <div><strong>Request failed.</strong> ${truncate(err?.message||'Unknown error',260)}</div>
      <div style="margin-top:8px; display:flex; gap:8px"><button class="chip retry" aria-label="Retry">Retry</button></div>
    </div>`;
    skel.querySelector('.retry')?.addEventListener('click', generate, { once:true });
    status('Error');
  }finally{ btn.setAttribute('aria-busy','false'); btn.disabled=false }
}

function normalizeOutput(o, opts){
  const { wantTitles, wantThumbs, count } = opts;
  const options = (o.options||[]).slice(0, count).map(x=> ({
    title: wantTitles ? (x.title||"").trim().slice(0,100) : undefined,
    thumbnailText: wantThumbs ? (x.thumbnailText||"").replace(/:/g,"").trim().slice(0,50) : undefined
  }));
  while(options.length < count) options.push({ title: wantTitles ? "" : undefined, thumbnailText: wantThumbs ? "" : undefined });

  const tp = Array.isArray(o.topPicks) ? o.topPicks
              .filter(v => Number.isInteger(v.index))
              .map(v => ({ index: clamp(parseInt(v.index,10)||1, 1, options.length) }))
              .slice(0, 2) : [];

  return { audienceProfile: (o.audienceProfile||"").trim(), options, topPicks: tp };
}

/* ================= INIT / UI ================= */
function renderAll(){
  const container = $("#stream"); container.innerHTML = "";
  store.loadSessions().forEach(s => {
    const wrap = document.createElement("div"); wrap.innerHTML = sessionHTML(s);
    container.appendChild(wrap);
  });
  attachCopyHandlers(container);
}
function bindUI(){
  const inputs = store.loadInputs();
  if(inputs.topic) $("#topic").value=inputs.topic;
  if(inputs.format) $("#format").value=inputs.format;
  if(inputs.audience) $("#audience").value=inputs.audience;
  if(typeof inputs.wantTitles==="boolean") $("#wantTitles").checked=inputs.wantTitles;
  if(typeof inputs.wantThumbs==="boolean") $("#wantThumbs").checked=inputs.wantThumbs;
  if(inputs.count) $("#count").value = clamp(parseInt(inputs.count,10)||10, 1, 15);

  $("#send").addEventListener("click", generate);
  document.addEventListener("keydown", (e)=>{ if(e.key==='Enter' && ['topic','format','audience'].includes(document.activeElement?.id)){ e.preventDefault(); generate(); } });

  $("#clear-history").addEventListener("click", ()=>{
    if(confirm("Clear all saved generations? This cannot be undone.")){
      store.clearSessions(); renderAll(); toast("History cleared");
    }
  });

  $("#copy-all-titles").addEventListener("click", ()=>{
    const items = [...document.querySelectorAll('.txt[data-kind="title"]')].map(n=> n.textContent.trim()).filter(Boolean).join("\n");
    navigator.clipboard.writeText(items).then(()=> toast("Copied")).catch(()=> toast("Copy failed"));
  });
  $("#copy-all-thumbs").addEventListener("click", ()=>{
    const items = [...document.querySelectorAll('.txt[data-kind="thumb"]')].map(n=> n.textContent.trim()).filter(Boolean).join("\n");
    navigator.clipboard.writeText(items).then(()=> toast("Copied")).catch(()=> toast("Copy failed"));
  });

  renderAll();
}
bindUI();
</script>
</body>
</html>
